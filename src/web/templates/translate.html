{% extends "base.html" %}

{% block title %}Translate - {{ metadata.original_name }}{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white">Translate</h1>
            <p class="text-gray-400 mt-1">{{ metadata.original_name }}</p>
        </div>
    </div>

    <!-- Translation Config -->
    <div id="config-section" class="bg-gray-800 rounded-lg border border-gray-700 p-6">
        <h2 class="text-lg font-semibold text-white mb-4">Translation Settings</h2>

        <form id="translate-form" class="space-y-6">
            <!-- Language Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-3">Target Languages</label>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <label class="flex items-center space-x-2 bg-gray-700 rounded-lg p-3 cursor-pointer hover:bg-gray-650">
                        <input type="checkbox" name="languages" value="de" checked class="rounded text-emerald-500 bg-gray-600 border-gray-500 focus:ring-emerald-500">
                        <span class="text-lg">ðŸ‡©ðŸ‡ª</span>
                        <span class="text-white">German</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 rounded-lg p-3 cursor-pointer hover:bg-gray-650">
                        <input type="checkbox" name="languages" value="fr" checked class="rounded text-emerald-500 bg-gray-600 border-gray-500 focus:ring-emerald-500">
                        <span class="text-lg">ðŸ‡«ðŸ‡·</span>
                        <span class="text-white">French</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 rounded-lg p-3 cursor-pointer hover:bg-gray-650">
                        <input type="checkbox" name="languages" value="it" checked class="rounded text-emerald-500 bg-gray-600 border-gray-500 focus:ring-emerald-500">
                        <span class="text-lg">ðŸ‡®ðŸ‡¹</span>
                        <span class="text-white">Italian</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 rounded-lg p-3 cursor-pointer hover:bg-gray-650">
                        <input type="checkbox" name="languages" value="es" checked class="rounded text-emerald-500 bg-gray-600 border-gray-500 focus:ring-emerald-500">
                        <span class="text-lg">ðŸ‡ªðŸ‡¸</span>
                        <span class="text-white">Spanish</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-700 rounded-lg p-3 cursor-pointer hover:bg-gray-650">
                        <input type="checkbox" name="languages" value="ro" checked class="rounded text-emerald-500 bg-gray-600 border-gray-500 focus:ring-emerald-500">
                        <span class="text-lg">ðŸ‡·ðŸ‡´</span>
                        <span class="text-white">Romanian</span>
                    </label>
                </div>
            </div>

            <!-- Quality Threshold -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Quality Threshold</label>
                <div class="flex items-center space-x-4">
                    <input
                        type="range"
                        id="quality-threshold"
                        name="quality_threshold"
                        min="50"
                        max="100"
                        value="80"
                        class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                    >
                    <span id="threshold-value" class="text-white font-medium w-12">80%</span>
                </div>
                <p class="mt-2 text-sm text-gray-400">
                    Translations below this score will be re-translated with GPT-4
                </p>
            </div>

            <!-- Start Button -->
            <button
                type="submit"
                class="w-full bg-emerald-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-emerald-700 transition-colors"
            >
                Start Translation
            </button>
        </form>
    </div>

    <!-- Progress Section (hidden initially) -->
    <div id="progress-section" class="hidden bg-gray-800 rounded-lg border border-gray-700 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-white">Translation Progress</h2>
            <button
                id="cancel-btn"
                class="text-red-400 hover:text-red-300 text-sm"
            >
                Cancel
            </button>
        </div>

        <!-- Overall Progress -->
        <div class="mb-6">
            <div class="flex justify-between text-sm text-gray-400 mb-2">
                <span id="progress-status">Initializing...</span>
                <span id="progress-percent">0%</span>
            </div>
            <div class="bg-gray-700 rounded-full h-3">
                <div id="progress-bar" class="bg-emerald-500 rounded-full h-3 transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Current Language -->
        <div class="mb-6">
            <div class="text-sm text-gray-400 mb-2">Current Language</div>
            <div id="current-language" class="text-xl font-medium text-white">-</div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-gray-750 rounded-lg p-4">
                <div class="text-sm text-gray-400">DeepL</div>
                <div id="stat-deepl" class="text-2xl font-bold text-emerald-400">0</div>
            </div>
            <div class="bg-gray-750 rounded-lg p-4">
                <div class="text-sm text-gray-400">GPT-4</div>
                <div id="stat-gpt4" class="text-2xl font-bold text-blue-400">0</div>
            </div>
            <div class="bg-gray-750 rounded-lg p-4">
                <div class="text-sm text-gray-400">Green</div>
                <div id="stat-green" class="text-2xl font-bold text-green-400">0</div>
            </div>
            <div class="bg-gray-750 rounded-lg p-4">
                <div class="text-sm text-gray-400">Yellow</div>
                <div id="stat-yellow" class="text-2xl font-bold text-yellow-400">0</div>
            </div>
        </div>

        <!-- Log -->
        <div class="mt-6">
            <div class="text-sm text-gray-400 mb-2">Activity Log</div>
            <div id="activity-log" class="bg-gray-900 rounded-lg p-4 h-48 overflow-y-auto font-mono text-sm text-gray-300">
            </div>
        </div>
    </div>

    <!-- Complete Section (hidden initially) -->
    <div id="complete-section" class="hidden bg-gray-800 rounded-lg border border-emerald-600 p-6">
        <div class="flex items-center space-x-3 mb-4">
            <svg class="h-8 w-8 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h2 class="text-lg font-semibold text-white">Translation Complete!</h2>
        </div>

        <div id="complete-summary" class="space-y-4">
            <!-- Will be populated by JS -->
        </div>

        <div class="flex space-x-3 mt-6">
            <a
                href="/stats"
                class="flex-1 bg-gray-700 text-white py-2 px-4 rounded-lg font-medium text-center hover:bg-gray-600 transition-colors"
            >
                View Stats
            </a>
            <!-- Direct mode: Apply button (hidden by default) -->
            <button
                id="apply-to-file-btn"
                class="hidden flex-1 bg-emerald-600 text-white py-2 px-4 rounded-lg font-medium text-center hover:bg-emerald-700 transition-colors"
            >
                Apply to File
            </button>
            <!-- Upload mode: Download button -->
            <a
                id="download-btn"
                href="/api/files/{{ file_id }}/download"
                class="flex-1 bg-emerald-600 text-white py-2 px-4 rounded-lg font-medium text-center hover:bg-emerald-700 transition-colors"
            >
                Download File
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const fileId = '{{ file_id }}';
    let eventSource = null;
    let currentJobId = null;

    // Threshold slider
    const thresholdSlider = document.getElementById('quality-threshold');
    const thresholdValue = document.getElementById('threshold-value');
    thresholdSlider.addEventListener('input', () => {
        thresholdValue.textContent = thresholdSlider.value + '%';
    });

    // Form submit
    document.getElementById('translate-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        // Get selected languages
        const checkboxes = document.querySelectorAll('input[name="languages"]:checked');
        const languages = Array.from(checkboxes).map(cb => cb.value);

        if (languages.length === 0) {
            showToast('Please select at least one language', 'error');
            return;
        }

        // Start translation
        try {
            const response = await fetch(`/api/translate/${fileId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    languages: languages,
                    quality_threshold: parseFloat(thresholdSlider.value),
                }),
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to start translation');
            }

            const data = await response.json();
            currentJobId = data.job_id;

            // Show progress section
            document.getElementById('config-section').classList.add('hidden');
            document.getElementById('progress-section').classList.remove('hidden');

            // Connect to SSE stream
            connectSSE(data.job_id);

        } catch (error) {
            showToast(error.message, 'error');
        }
    });

    function connectSSE(jobId) {
        eventSource = new EventSource(`/api/translate/${jobId}/stream`);

        eventSource.addEventListener('progress', (e) => {
            const data = JSON.parse(e.data);
            updateProgress(data);
        });

        eventSource.addEventListener('complete', (e) => {
            const data = JSON.parse(e.data);
            eventSource.close();
            showComplete(data.result);
        });

        eventSource.addEventListener('error', (e) => {
            eventSource.close();
            try {
                const data = JSON.parse(e.data);
                showToast(data.error || 'Translation failed', 'error');
            } catch {
                showToast('Connection lost', 'error');
            }
        });

        eventSource.onerror = () => {
            // Handle connection error
            if (eventSource.readyState === EventSource.CLOSED) {
                addLog('Connection closed');
            }
        };
    }

    function updateProgress(data) {
        // Update progress bar
        const percent = data.percentage || 0;
        document.getElementById('progress-bar').style.width = `${percent}%`;
        document.getElementById('progress-percent').textContent = `${Math.round(percent)}%`;
        document.getElementById('progress-status').textContent = data.message || 'Processing...';

        // Update current language
        if (data.language) {
            const langNames = {de: 'German', fr: 'French', it: 'Italian', es: 'Spanish', ro: 'Romanian'};
            document.getElementById('current-language').textContent = langNames[data.language] || data.language;
        }

        // Update stats if available
        if (data.stats) {
            document.getElementById('stat-deepl').textContent = data.stats.deepl_count || 0;
            document.getElementById('stat-gpt4').textContent = data.stats.gpt4_count || 0;
            document.getElementById('stat-green').textContent = data.stats.green_count || 0;
            document.getElementById('stat-yellow').textContent = data.stats.yellow_count || 0;
        }

        // Add log entry
        addLog(data.message);
    }

    function addLog(message) {
        const log = document.getElementById('activity-log');
        const time = new Date().toLocaleTimeString();
        log.innerHTML += `<div><span class="text-gray-500">[${time}]</span> ${message}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    function showComplete(result) {
        document.getElementById('progress-section').classList.add('hidden');
        document.getElementById('complete-section').classList.remove('hidden');

        // Update header badge with untranslated count
        window.updateUntranslatedBadge(fileId);

        const summary = document.getElementById('complete-summary');
        let html = `
            <div class="text-gray-400">
                Languages processed: <span class="text-white">${result.languages_processed.join(', ').toUpperCase()}</span>
            </div>
        `;

        // Show stats per language
        if (result.stats_by_language) {
            html += '<div class="mt-4 space-y-3">';
            for (const [lang, stats] of Object.entries(result.stats_by_language)) {
                html += `
                    <div class="bg-gray-750 rounded-lg p-4">
                        <div class="font-medium text-white mb-2">${lang.toUpperCase()}</div>
                        <div class="grid grid-cols-4 gap-2 text-sm">
                            <div>
                                <span class="text-gray-400">DeepL:</span>
                                <span class="text-emerald-400 ml-1">${stats.deepl_count}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">GPT-4:</span>
                                <span class="text-blue-400 ml-1">${stats.gpt4_count}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Green:</span>
                                <span class="text-green-400 ml-1">${stats.green_count}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Yellow:</span>
                                <span class="text-yellow-400 ml-1">${stats.yellow_count}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
        }

        summary.innerHTML = html;
    }

    // Cancel button
    document.getElementById('cancel-btn').addEventListener('click', () => {
        if (eventSource) {
            eventSource.close();
        }
        showToast('Translation cancelled', 'warning');
        window.location.href = '/';
    });

    // Check if in direct mode and show Apply button
    let isDirectMode = false;
    async function checkDirectMode() {
        try {
            const response = await fetch('/api/direct/config');
            const data = await response.json();

            if (data.configured && data.file_id === fileId) {
                isDirectMode = true;
                document.getElementById('apply-to-file-btn').classList.remove('hidden');
                document.getElementById('download-btn').classList.add('hidden');
            }
        } catch (e) {
            // Ignore, show download button by default
        }
    }

    checkDirectMode();

    // Update header badge on page load
    window.updateUntranslatedBadge(fileId);

    // Apply button handler
    document.getElementById('apply-to-file-btn').addEventListener('click', async () => {
        if (!confirm('Apply translations to the configured file?')) return;

        try {
            const response = await fetch('/api/direct/apply', {method: 'POST'});
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to apply');
            }
            showToast('Translations applied to file!', 'success');
        } catch (error) {
            showToast(error.message, 'error');
        }
    });
</script>
{% endblock %}
