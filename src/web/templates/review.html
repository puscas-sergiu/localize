{% extends "base.html" %}

{% block title %}Review {{ language|upper }} - {{ metadata.original_name }}{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <div class="flex items-center space-x-2 text-gray-400 text-sm mb-2">
                <a href="/" class="hover:text-white">Dashboard</a>
                <span>/</span>
                <a href="/stats/{{ file_id }}" class="hover:text-white">{{ metadata.original_name }}</a>
                <span>/</span>
                <span>Review {{ language|upper }}</span>
            </div>
            <h1 class="text-3xl font-bold text-white">Review Translations</h1>
            <p class="mt-2 text-gray-400">{{ language|upper }} translations for {{ metadata.original_name }}</p>
        </div>
        <div class="flex space-x-3">
            <button
                id="verify-btn"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors"
            >
                Run LLM Verification
            </button>
            <a
                href="/api/files/{{ file_id }}/download"
                class="bg-gray-700 text-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-600 transition-colors"
            >
                Download
            </a>
        </div>
    </div>

    <!-- Filter -->
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
        <div class="flex items-center space-x-4">
            <span class="text-gray-400">Filter:</span>
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="radio" name="state-filter" value="" checked class="text-emerald-500 bg-gray-600 border-gray-500 focus:ring-emerald-500">
                <span class="text-white">All</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="radio" name="state-filter" value="translated" class="text-emerald-500 bg-gray-600 border-gray-500 focus:ring-emerald-500">
                <span class="text-white">Translated</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="radio" name="state-filter" value="needs_review" class="text-emerald-500 bg-gray-600 border-gray-500 focus:ring-emerald-500">
                <span class="text-white">Needs Review</span>
            </label>
        </div>
    </div>

    <!-- Translations Table -->
    <div class="bg-gray-800 rounded-lg border border-gray-700">
        <div class="px-6 py-4 border-b border-gray-700 flex items-center justify-between">
            <h2 class="text-lg font-semibold text-white">Translations</h2>
            <span id="translation-count" class="text-gray-400 text-sm"></span>
        </div>

        <div id="translations-container" class="divide-y divide-gray-700">
            <!-- Loading state -->
            <div class="px-6 py-12 text-center">
                <svg class="animate-spin mx-auto h-8 w-8 text-emerald-500" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
    </div>

    <!-- Verification Modal -->
    <div id="verify-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-lg w-full mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">LLM Verification</h3>

            <div id="verify-config" class="space-y-4">
                <div>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="verify-all" class="rounded text-emerald-500 bg-gray-600 border-gray-500 focus:ring-emerald-500">
                        <span class="text-white">Review all translations</span>
                    </label>
                    <p class="text-sm text-gray-400 mt-1 ml-6">By default, only translations marked as "needs review" are verified</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Limit (optional)</label>
                    <input
                        type="number"
                        id="verify-limit"
                        placeholder="No limit"
                        min="1"
                        max="100"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:ring-emerald-500 focus:border-emerald-500"
                    >
                </div>

                <div class="flex space-x-3 pt-4">
                    <button
                        id="close-verify-modal"
                        class="flex-1 bg-gray-700 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors"
                    >
                        Cancel
                    </button>
                    <button
                        id="start-verify"
                        class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 transition-colors"
                    >
                        Start Verification
                    </button>
                </div>
            </div>

            <div id="verify-progress" class="hidden space-y-4">
                <div>
                    <div class="flex justify-between text-sm text-gray-400 mb-2">
                        <span id="verify-status">Starting verification...</span>
                        <span id="verify-percent">0%</span>
                    </div>
                    <div class="bg-gray-700 rounded-full h-3">
                        <div id="verify-progress-bar" class="bg-blue-500 rounded-full h-3 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="verify-results" class="hidden space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-750 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-green-400" id="result-passed">0</div>
                        <div class="text-sm text-gray-400">Passed</div>
                    </div>
                    <div class="bg-gray-750 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-yellow-400" id="result-attention">0</div>
                        <div class="text-sm text-gray-400">Needs Attention</div>
                    </div>
                </div>

                <div id="issues-list" class="max-h-64 overflow-y-auto space-y-2">
                    <!-- Issues will be listed here -->
                </div>

                <button
                    id="close-results"
                    class="w-full bg-gray-700 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors"
                >
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const fileId = '{{ file_id }}';
    const language = '{{ language }}';
    let translations = [];
    let currentFilter = '';

    async function loadTranslations(stateFilter = '') {
        try {
            let url = `/api/review/${fileId}/${language}`;
            if (stateFilter) {
                url += `?state=${stateFilter}`;
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load translations');

            const data = await response.json();
            translations = data.translations;
            currentFilter = stateFilter;
            renderTranslations();

        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    function renderTranslations() {
        const container = document.getElementById('translations-container');
        const count = document.getElementById('translation-count');

        count.textContent = `${translations.length} translations`;

        if (translations.length === 0) {
            container.innerHTML = `
                <div class="px-6 py-12 text-center text-gray-400">
                    No translations found
                </div>
            `;
            return;
        }

        let html = '';
        for (const t of translations) {
            const stateColor = t.state === 'translated' ? 'bg-emerald-600' :
                              t.state === 'needs_review' ? 'bg-yellow-600' : 'bg-gray-600';
            const stateText = t.state === 'translated' ? 'Translated' :
                             t.state === 'needs_review' ? 'Needs Review' : t.state;

            html += `
                <div class="px-6 py-4 hover:bg-gray-750 transition-colors" data-key="${escapeHtml(t.key)}">
                    <div class="flex items-start justify-between mb-2">
                        <code class="text-sm text-gray-400 break-all">${escapeHtml(t.key)}</code>
                        <span class="${stateColor} text-white text-xs px-2 py-1 rounded">${stateText}</span>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs text-gray-500 mb-1">Source (EN)</div>
                            <div class="text-gray-300">${escapeHtml(t.source)}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">Translation (${language.toUpperCase()})</div>
                            <div class="translation-text text-white" data-key="${escapeHtml(t.key)}">${escapeHtml(t.translation)}</div>
                        </div>
                    </div>

                    <div class="mt-3 flex justify-end">
                        <button
                            onclick="editTranslation('${escapeHtml(t.key)}')"
                            class="text-emerald-400 hover:text-emerald-300 text-sm"
                        >
                            Edit
                        </button>
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function editTranslation(key) {
        const t = translations.find(t => t.key === key);
        if (!t) return;

        const newTranslation = prompt('Edit translation:', t.translation);
        if (newTranslation === null || newTranslation === t.translation) return;

        try {
            const response = await fetch(`/api/review/${fileId}/${language}/${encodeURIComponent(key)}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    translation: newTranslation,
                    state: 'translated',
                }),
            });

            if (!response.ok) throw new Error('Failed to update translation');

            showToast('Translation updated', 'success');
            loadTranslations(currentFilter);

        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    // Filter change
    document.querySelectorAll('input[name="state-filter"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            loadTranslations(e.target.value);
        });
    });

    // Verification modal
    const verifyModal = document.getElementById('verify-modal');
    const verifyConfig = document.getElementById('verify-config');
    const verifyProgress = document.getElementById('verify-progress');
    const verifyResults = document.getElementById('verify-results');

    document.getElementById('verify-btn').addEventListener('click', () => {
        verifyModal.classList.remove('hidden');
        verifyConfig.classList.remove('hidden');
        verifyProgress.classList.add('hidden');
        verifyResults.classList.add('hidden');
    });

    document.getElementById('close-verify-modal').addEventListener('click', () => {
        verifyModal.classList.add('hidden');
    });

    document.getElementById('close-results').addEventListener('click', () => {
        verifyModal.classList.add('hidden');
    });

    document.getElementById('start-verify').addEventListener('click', async () => {
        verifyConfig.classList.add('hidden');
        verifyProgress.classList.remove('hidden');

        const reviewAll = document.getElementById('verify-all').checked;
        const limitInput = document.getElementById('verify-limit').value;
        const limit = limitInput ? parseInt(limitInput) : null;

        try {
            const response = await fetch(`/api/verify/${fileId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    language: language,
                    review_all: reviewAll,
                    limit: limit,
                }),
            });

            if (!response.ok) throw new Error('Failed to start verification');

            const data = await response.json();
            connectVerifySSE(data.job_id);

        } catch (error) {
            showToast(error.message, 'error');
            verifyModal.classList.add('hidden');
        }
    });

    function connectVerifySSE(jobId) {
        const eventSource = new EventSource(`/api/verify/${jobId}/stream`);

        eventSource.addEventListener('progress', (e) => {
            const data = JSON.parse(e.data);
            document.getElementById('verify-progress-bar').style.width = `${data.percentage}%`;
            document.getElementById('verify-percent').textContent = `${Math.round(data.percentage)}%`;
            document.getElementById('verify-status').textContent = data.message;
        });

        eventSource.addEventListener('complete', (e) => {
            eventSource.close();
            const data = JSON.parse(e.data);
            showVerifyResults(data.result);
        });

        eventSource.addEventListener('error', (e) => {
            eventSource.close();
            showToast('Verification failed', 'error');
            verifyModal.classList.add('hidden');
        });
    }

    function showVerifyResults(result) {
        verifyProgress.classList.add('hidden');
        verifyResults.classList.remove('hidden');

        document.getElementById('result-passed').textContent = result.passed;
        document.getElementById('result-attention').textContent = result.needs_attention;

        const issuesList = document.getElementById('issues-list');
        if (result.issues && result.issues.length > 0) {
            let html = '<div class="text-sm text-gray-400 mb-2">Issues found:</div>';
            for (const issue of result.issues) {
                html += `
                    <div class="bg-gray-750 rounded-lg p-3">
                        <code class="text-xs text-gray-400 break-all">${escapeHtml(issue.key)}</code>
                        <div class="text-yellow-400 text-sm mt-1">${issue.issues.join(', ')}</div>
                        ${issue.suggested_fix ? `<div class="text-emerald-400 text-sm mt-1">Suggested: ${escapeHtml(issue.suggested_fix)}</div>` : ''}
                    </div>
                `;
            }
            issuesList.innerHTML = html;
        } else {
            issuesList.innerHTML = '<div class="text-center text-gray-400">No issues found!</div>';
        }

        // Reload translations to reflect any changes
        loadTranslations(currentFilter);
    }

    // Load translations on page load
    loadTranslations();
</script>
{% endblock %}
