{% extends "base.html" %}

{% block title %}{% if file_configured %}Review {{ language|upper }} - {{ metadata.original_name }}{% else %}Review - MintDeck Localizer{% endif %}{% endblock %}

{% block content %}
{% if not file_configured %}
<!-- No file configured state -->
<div class="flex flex-col items-center justify-center min-h-[60vh]">
    <svg class="h-20 w-20 text-gray-600 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
    </svg>
    <h1 class="text-2xl font-bold text-white mb-3">No File Configured</h1>
    <p class="text-gray-400 mb-8 text-center max-w-md">
        Configure a localization file to start reviewing and translating your strings.
    </p>
    <a href="/settings" class="bg-emerald-600 text-white px-8 py-3 rounded-lg font-medium hover:bg-emerald-700 transition-colors flex items-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
        <span>Go to Settings</span>
    </a>
</div>
{% else %}
<!-- Review page content -->
<div class="flex h-[calc(100vh-6rem)]">
    <!-- Left Sidebar: Language Navigation -->
    <div id="language-sidebar" class="w-56 bg-gray-800 border-r border-gray-700 flex-shrink-0 flex flex-col">
        <div class="px-4 py-3 border-b border-gray-700">
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Languages</h3>
        </div>
        <div id="language-list" class="py-2 flex-1 overflow-y-auto">
            <div class="px-4 py-2 text-gray-500 text-sm">Loading...</div>
        </div>
        <div class="p-3 border-t border-gray-700">
            <button
                id="add-language-btn"
                class="w-full bg-gray-700 text-gray-300 px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-600 transition-colors flex items-center justify-center space-x-2"
            >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                <span>Add Language</span>
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-700 bg-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold text-white">Review <span id="lang-title">{{ language|upper }}</span> Translations</h1>
                    <p class="text-sm text-gray-400 mt-1">{{ metadata.original_name }}</p>
                </div>
                <div class="flex space-x-3">
                    <button
                        id="translate-all-btn"
                        class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-emerald-700 transition-colors flex items-center space-x-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                        </svg>
                        <span>Translate All Untranslated</span>
                    </button>
                    <button
                        id="verify-btn"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors"
                    >
                        Run LLM Verification
                    </button>
                    <a
                        href="/api/files/{{ file_id }}/download"
                        class="bg-gray-700 text-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-600 transition-colors"
                    >
                        Download
                    </a>
                </div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="px-6 py-3 bg-gray-750 border-b border-gray-700 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <span class="text-gray-400 text-sm">Filter:</span>
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="state-filter" value="" checked class="text-emerald-500 bg-gray-600 border-gray-500 focus:ring-emerald-500">
                    <span class="text-white text-sm">All</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="state-filter" value="translated" class="text-emerald-500 bg-gray-600 border-gray-500 focus:ring-emerald-500">
                    <span class="text-white text-sm">Translated</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="state-filter" value="needs_review" class="text-emerald-500 bg-gray-600 border-gray-500 focus:ring-emerald-500">
                    <span class="text-white text-sm">Needs Review</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="state-filter" value="not_translated" class="text-emerald-500 bg-gray-600 border-gray-500 focus:ring-emerald-500">
                    <span class="text-white text-sm">Not Translated</span>
                </label>
            </div>
            <span id="translation-count" class="text-gray-400 text-sm"></span>
        </div>

        <!-- Translations Table -->
        <div class="flex-1 overflow-auto">
            <table class="w-full">
                <thead class="bg-gray-750 sticky top-0 z-10">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-1/4">Key</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-1/4">Source (EN)</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                            Translation (<span id="lang-header">{{ language|upper }}</span>)
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-28">State</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider w-20">Actions</th>
                    </tr>
                </thead>
                <tbody id="translations-tbody" class="divide-y divide-gray-700">
                    <!-- Loading state -->
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center">
                            <svg class="animate-spin mx-auto h-8 w-8 text-emerald-500" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Verification Modal -->
    <div id="verify-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-lg w-full mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">LLM Verification</h3>

            <div id="verify-config" class="space-y-4">
                <div>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="verify-all" class="rounded text-emerald-500 bg-gray-600 border-gray-500 focus:ring-emerald-500">
                        <span class="text-white">Review all translations</span>
                    </label>
                    <p class="text-sm text-gray-400 mt-1 ml-6">By default, only translations marked as "needs review" are verified</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Limit (optional)</label>
                    <input
                        type="number"
                        id="verify-limit"
                        placeholder="No limit"
                        min="1"
                        max="100"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:ring-emerald-500 focus:border-emerald-500"
                    >
                </div>

                <div class="flex space-x-3 pt-4">
                    <button
                        id="close-verify-modal"
                        class="flex-1 bg-gray-700 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors"
                    >
                        Cancel
                    </button>
                    <button
                        id="start-verify"
                        class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 transition-colors"
                    >
                        Start Verification
                    </button>
                </div>
            </div>

            <div id="verify-progress" class="hidden space-y-4">
                <div>
                    <div class="flex justify-between text-sm text-gray-400 mb-2">
                        <span id="verify-status">Starting verification...</span>
                        <span id="verify-percent">0%</span>
                    </div>
                    <div class="bg-gray-700 rounded-full h-3">
                        <div id="verify-progress-bar" class="bg-blue-500 rounded-full h-3 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="verify-results" class="hidden space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-750 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-green-400" id="result-passed">0</div>
                        <div class="text-sm text-gray-400">Passed</div>
                    </div>
                    <div class="bg-gray-750 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-yellow-400" id="result-attention">0</div>
                        <div class="text-sm text-gray-400">Needs Attention</div>
                    </div>
                </div>

                <div id="issues-list" class="max-h-64 overflow-y-auto space-y-2">
                    <!-- Issues will be listed here -->
                </div>

                <button
                    id="close-results"
                    class="w-full bg-gray-700 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors"
                >
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Translation Progress Modal -->
    <div id="translate-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-lg w-full mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">Translating Untranslated Strings</h3>

            <div id="translate-progress" class="space-y-4">
                <div>
                    <div class="flex justify-between text-sm text-gray-400 mb-2">
                        <span id="translate-status">Starting translation...</span>
                        <span id="translate-percent">0%</span>
                    </div>
                    <div class="bg-gray-700 rounded-full h-3">
                        <div id="translate-progress-bar" class="bg-emerald-500 rounded-full h-3 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="translate-results" class="hidden space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-750 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-emerald-400" id="translate-green">0</div>
                        <div class="text-sm text-gray-400">High Quality</div>
                    </div>
                    <div class="bg-gray-750 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-yellow-400" id="translate-yellow">0</div>
                        <div class="text-sm text-gray-400">Needs Review</div>
                    </div>
                </div>

                <button
                    id="close-translate"
                    class="w-full bg-gray-700 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors"
                >
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Add Language Modal -->
    <div id="add-language-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">Add New Language</h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Select a language or enter a code</label>
                    <select
                        id="language-select"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-emerald-500 focus:border-emerald-500"
                    >
                        <option value="">-- Select a language --</option>
                        <option value="ar">Arabic (ar)</option>
                        <option value="zh-Hans">Chinese Simplified (zh-Hans)</option>
                        <option value="zh-Hant">Chinese Traditional (zh-Hant)</option>
                        <option value="cs">Czech (cs)</option>
                        <option value="da">Danish (da)</option>
                        <option value="nl">Dutch (nl)</option>
                        <option value="fi">Finnish (fi)</option>
                        <option value="el">Greek (el)</option>
                        <option value="he">Hebrew (he)</option>
                        <option value="hi">Hindi (hi)</option>
                        <option value="hu">Hungarian (hu)</option>
                        <option value="id">Indonesian (id)</option>
                        <option value="ja">Japanese (ja)</option>
                        <option value="ko">Korean (ko)</option>
                        <option value="ms">Malay (ms)</option>
                        <option value="nb">Norwegian Bokmal (nb)</option>
                        <option value="pl">Polish (pl)</option>
                        <option value="pt-BR">Portuguese Brazil (pt-BR)</option>
                        <option value="pt-PT">Portuguese Portugal (pt-PT)</option>
                        <option value="ru">Russian (ru)</option>
                        <option value="sk">Slovak (sk)</option>
                        <option value="sv">Swedish (sv)</option>
                        <option value="th">Thai (th)</option>
                        <option value="tr">Turkish (tr)</option>
                        <option value="uk">Ukrainian (uk)</option>
                        <option value="vi">Vietnamese (vi)</option>
                        <option value="custom">Other (enter code below)</option>
                    </select>
                </div>

                <div id="custom-language-input" class="hidden">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Custom language code</label>
                    <input
                        type="text"
                        id="custom-language-code"
                        placeholder="e.g., ca, bg, hr"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:ring-emerald-500 focus:border-emerald-500"
                    >
                    <p class="text-xs text-gray-500 mt-1">Use ISO 639-1 codes (e.g., 'ja') or BCP 47 tags (e.g., 'zh-Hans')</p>
                </div>

                <div id="add-language-error" class="hidden text-red-400 text-sm"></div>

                <div class="flex space-x-3 pt-4">
                    <button
                        id="cancel-add-language"
                        class="flex-1 bg-gray-700 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors"
                    >
                        Cancel
                    </button>
                    <button
                        id="confirm-add-language"
                        class="flex-1 bg-emerald-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        Add Language
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Single Translation Review Modal -->
    <div id="review-single-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-lg w-full mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">LLM Review</h3>

            <!-- Loading State -->
            <div id="review-single-loading" class="space-y-4">
                <div class="flex items-center justify-center py-8">
                    <svg class="animate-spin h-8 w-8 text-purple-500" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                </div>
                <p class="text-center text-gray-400">Analyzing translation...</p>
            </div>

            <!-- Results State -->
            <div id="review-single-results" class="hidden space-y-4">
                <!-- Current Translation -->
                <div class="bg-gray-750 rounded-lg p-3">
                    <div class="text-xs text-gray-500 uppercase mb-1">Current Translation</div>
                    <div id="review-current-translation" class="text-gray-300"></div>
                </div>

                <!-- Issues Section -->
                <div id="review-issues-section">
                    <div class="text-sm font-medium text-gray-400 mb-2">Issues Found</div>
                    <div id="review-issues-list" class="space-y-2">
                        <!-- Issues will be inserted here -->
                    </div>
                </div>

                <!-- No Issues Message -->
                <div id="review-no-issues" class="hidden">
                    <div class="flex items-center space-x-2 text-emerald-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>No issues found - translation looks good!</span>
                    </div>
                </div>

                <!-- Suggestions Section -->
                <div>
                    <div class="text-sm font-medium text-gray-400 mb-2">Suggestions</div>
                    <div id="review-suggestions-list" class="space-y-2">
                        <!-- Suggestions with Apply buttons will be inserted here -->
                    </div>
                </div>

                <!-- Close Button -->
                <button
                    id="close-review-single"
                    class="w-full bg-gray-700 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors mt-4"
                >
                    Close
                </button>
            </div>

            <!-- Error State -->
            <div id="review-single-error" class="hidden space-y-4">
                <div class="flex items-center space-x-2 text-red-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span id="review-error-message">Failed to review translation</span>
                </div>
                <button
                    id="close-review-error"
                    class="w-full bg-gray-700 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors"
                >
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if file_configured %}
<script>
    const fileId = '{{ file_id }}';
    let language = '{{ language }}';
    let translations = [];
    let currentFilter = '';

    // Language display names
    const languageNames = {
        'en': 'English',
        'de': 'German',
        'fr': 'French',
        'it': 'Italian',
        'es': 'Spanish',
        'ro': 'Romanian',
    };

    const flagEmojis = {
        'en': 'üá∫üá∏',
        'de': 'üá©üá™',
        'fr': 'üá´üá∑',
        'it': 'üáÆüáπ',
        'es': 'üá™üá∏',
        'ro': 'üá∑üá¥',
    };

    // Load language sidebar
    async function loadLanguageSidebar() {
        try {
            const response = await fetch(`/api/stats/${fileId}`);
            if (!response.ok) throw new Error('Failed to load stats');

            const stats = await response.json();
            const languageList = document.getElementById('language-list');

            let html = '';
            for (const lang of Object.keys(stats.coverage).sort()) {
                const coverage = stats.coverage[lang];
                const isActive = lang === language;
                const activeClass = isActive ? 'bg-emerald-600/20 border-l-2 border-emerald-500' : 'border-l-2 border-transparent';
                const colorClass = coverage.percentage >= 90 ? 'text-emerald-400' :
                                  coverage.percentage >= 50 ? 'text-yellow-400' : 'text-red-400';

                html += `
                    <a
                        href="/review/${lang}"
                        class="block px-4 py-3 hover:bg-gray-700 transition-colors ${activeClass}"
                    >
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-base">${flagEmojis[lang] || 'üåê'}</span>
                                <span class="text-white text-sm font-medium">${languageNames[lang] || lang.toUpperCase()}</span>
                            </div>
                            <span class="${colorClass} text-sm font-medium">${coverage.percentage}%</span>
                        </div>
                        <div class="mt-1 text-xs text-gray-500 pl-6">
                            ${coverage.translated}/${coverage.total}
                        </div>
                    </a>
                `;
            }

            languageList.innerHTML = html || '<div class="px-4 py-2 text-gray-500 text-sm">No languages found</div>';

        } catch (error) {
            console.error('Failed to load language sidebar:', error);
        }
    }

    // Load translations
    async function loadTranslations(stateFilter = '') {
        try {
            let url = `/api/review/${fileId}/${language}`;
            if (stateFilter) {
                url += `?state=${stateFilter}`;
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load translations');

            const data = await response.json();
            translations = data.translations;
            currentFilter = stateFilter;
            renderTranslations();
            // Update header badge with untranslated count
            window.updateUntranslatedBadge(fileId);

        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    function renderTranslations() {
        const tbody = document.getElementById('translations-tbody');
        const count = document.getElementById('translation-count');

        count.textContent = `${translations.length} strings`;

        if (translations.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-12 text-center text-gray-400">
                        No translations found
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';
        for (const t of translations) {
            const isUntranslated = t.state === 'not_translated' || !t.translation;
            const stateColor = t.state === 'translated' ? 'bg-emerald-600' :
                              t.state === 'needs_review' ? 'bg-yellow-600' :
                              t.state === 'not_translated' ? 'bg-gray-500' : 'bg-gray-600';
            const stateText = t.state === 'translated' ? 'Translated' :
                             t.state === 'needs_review' ? 'Needs Review' :
                             t.state === 'not_translated' ? 'New' : t.state;

            const rowBgClass = isUntranslated ? 'bg-amber-900/10' : '';
            const inputBorderClass = isUntranslated ? 'border-dashed border-amber-500/50' : 'border-gray-600';

            html += `
                <tr class="${rowBgClass} hover:bg-gray-750 transition-colors" data-key="${escapeHtml(t.key)}">
                    <td class="px-4 py-3">
                        <code class="text-xs text-gray-400 break-all">${escapeHtml(t.key)}</code>
                    </td>
                    <td class="px-4 py-3 text-gray-300 text-sm">${escapeHtml(t.source)}</td>
                    <td class="px-4 py-3">
                        <div class="relative">
                            <input
                                type="text"
                                class="translation-input w-full bg-gray-700 border ${inputBorderClass} rounded px-3 py-2 text-white text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                value="${escapeHtml(t.translation)}"
                                placeholder="${isUntranslated ? 'Not translated' : ''}"
                                data-key="${escapeHtml(t.key)}"
                                data-original="${escapeHtml(t.translation)}"
                                data-source="${escapeHtml(t.source)}"
                            >
                            <div class="save-indicator hidden absolute right-2 top-1/2 -translate-y-1/2">
                                <svg class="animate-spin h-4 w-4 text-emerald-500" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="state-badge ${stateColor} text-white text-xs px-2 py-1 rounded">${stateText}</span>
                    </td>
                    <td class="px-4 py-3 text-right">
                        ${isUntranslated ? `
                            <button
                                class="translate-single-btn text-blue-400 hover:text-blue-300 p-1"
                                data-key="${escapeHtml(t.key)}"
                                data-source="${escapeHtml(t.source)}"
                                title="Auto-translate this string"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                                </svg>
                            </button>
                        ` : `
                            <button
                                class="review-single-btn text-purple-400 hover:text-purple-300 p-1"
                                data-key="${escapeHtml(t.key)}"
                                data-source="${escapeHtml(t.source)}"
                                data-translation="${escapeHtml(t.translation)}"
                                title="LLM Review"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </button>
                        `}
                    </td>
                </tr>
            `;
        }

        tbody.innerHTML = html;
        setupInlineEditing();
        setupTranslateSingleButtons();
        setupReviewSingleButtons();
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Inline editing
    function setupInlineEditing() {
        document.querySelectorAll('.translation-input').forEach(input => {
            input.addEventListener('blur', async function() {
                const key = this.dataset.key;
                const original = this.dataset.original;
                const newValue = this.value.trim();

                if (newValue !== original && newValue !== '') {
                    await saveTranslation(key, newValue, this);
                }
            });

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur();
                } else if (e.key === 'Escape') {
                    this.value = this.dataset.original;
                    this.blur();
                }
            });
        });
    }

    async function saveTranslation(key, translation, inputElement) {
        const indicator = inputElement.parentElement.querySelector('.save-indicator');
        indicator?.classList.remove('hidden');

        try {
            const response = await fetch(`/api/review/${fileId}/${language}/${encodeURIComponent(key)}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    translation: translation,
                    state: 'translated',
                }),
            });

            if (!response.ok) throw new Error('Failed to save');

            inputElement.dataset.original = translation;

            // Update row styling
            const row = inputElement.closest('tr');
            row.classList.remove('bg-amber-900/10');
            inputElement.classList.remove('border-dashed', 'border-amber-500/50');
            inputElement.classList.add('border-gray-600');

            // Update state badge
            const stateBadge = row.querySelector('.state-badge');
            stateBadge.className = 'state-badge bg-emerald-600 text-white text-xs px-2 py-1 rounded';
            stateBadge.textContent = 'Translated';

            // Remove translate button if exists
            const translateBtn = row.querySelector('.translate-single-btn');
            translateBtn?.remove();

            showToast('Saved', 'success');

        } catch (error) {
            showToast(error.message, 'error');
            inputElement.value = inputElement.dataset.original;
        } finally {
            indicator?.classList.add('hidden');
        }
    }

    // Single string translation
    function setupTranslateSingleButtons() {
        document.querySelectorAll('.translate-single-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const key = this.dataset.key;
                const source = this.dataset.source;
                await autoTranslateSingle(key, source, this);
            });
        });
    }

    async function autoTranslateSingle(key, source, button) {
        const row = document.querySelector(`tr[data-key="${CSS.escape(key)}"]`);
        const input = row?.querySelector('.translation-input');

        // Show loading state
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `
            <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        `;

        try {
            const response = await fetch(`/api/review/${fileId}/${language}/translate-single`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ key, source }),
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Translation failed');
            }

            const data = await response.json();

            // Update the input field
            if (input) {
                input.value = data.translation;
                input.dataset.original = data.translation;
                input.classList.remove('border-dashed', 'border-amber-500/50');
                input.classList.add('border-gray-600');
            }

            // Update row styling
            row?.classList.remove('bg-amber-900/10');

            // Update state badge
            const stateBadge = row?.querySelector('.state-badge');
            if (stateBadge) {
                stateBadge.className = data.state === 'translated'
                    ? 'state-badge bg-emerald-600 text-white text-xs px-2 py-1 rounded'
                    : 'state-badge bg-yellow-600 text-white text-xs px-2 py-1 rounded';
                stateBadge.textContent = data.state === 'translated' ? 'Translated' : 'Needs Review';
            }

            // Remove translate button
            button.remove();

            showToast(`Translated via ${data.provider}`, 'success');

        } catch (error) {
            showToast(error.message, 'error');
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    // Single translation LLM review
    let currentReviewKey = null;

    function setupReviewSingleButtons() {
        document.querySelectorAll('.review-single-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const key = this.dataset.key;
                const source = this.dataset.source;
                const translation = this.dataset.translation;
                await reviewSingleTranslation(key, source, translation, this);
            });
        });
    }

    async function reviewSingleTranslation(key, source, translation, button) {
        currentReviewKey = key;

        const modal = document.getElementById('review-single-modal');
        const loading = document.getElementById('review-single-loading');
        const results = document.getElementById('review-single-results');
        const error = document.getElementById('review-single-error');

        // Show modal in loading state
        modal.classList.remove('hidden');
        loading.classList.remove('hidden');
        results.classList.add('hidden');
        error.classList.add('hidden');

        // Show loading state on button
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `
            <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
        `;

        try {
            const response = await fetch(`/api/review/${fileId}/${language}/review-single`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ key, source, translation }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Review failed');
            }

            const data = await response.json();
            showReviewResults(data);

        } catch (err) {
            showReviewError(err.message);
        } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    function showReviewResults(data) {
        const loading = document.getElementById('review-single-loading');
        const results = document.getElementById('review-single-results');
        const issuesSection = document.getElementById('review-issues-section');
        const noIssues = document.getElementById('review-no-issues');
        const issuesList = document.getElementById('review-issues-list');
        const suggestionsList = document.getElementById('review-suggestions-list');

        // Hide loading, show results
        loading.classList.add('hidden');
        results.classList.remove('hidden');

        // Show current translation
        document.getElementById('review-current-translation').textContent = data.original_translation;

        // Show issues or "no issues" message
        if (data.issues && data.issues.length > 0) {
            issuesSection.classList.remove('hidden');
            noIssues.classList.add('hidden');

            issuesList.innerHTML = data.issues.map(issue => `
                <div class="flex items-start space-x-2 text-yellow-400 text-sm">
                    <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <span>${escapeHtml(issue)}</span>
                </div>
            `).join('');
        } else {
            issuesSection.classList.add('hidden');
            noIssues.classList.remove('hidden');
        }

        // Show suggestions with Apply buttons
        if (data.suggestions && data.suggestions.length > 0) {
            suggestionsList.innerHTML = data.suggestions.map((suggestion, index) => `
                <div class="bg-gray-750 rounded-lg p-3 flex items-start justify-between space-x-3">
                    <div class="flex-1 min-w-0">
                        <div class="text-white break-words">${escapeHtml(suggestion.text)}</div>
                        <div class="text-xs text-gray-500 mt-1">${escapeHtml(suggestion.explanation)}</div>
                    </div>
                    <button
                        class="apply-suggestion-btn flex-shrink-0 bg-emerald-600 hover:bg-emerald-700 text-white text-xs px-3 py-1.5 rounded font-medium transition-colors"
                        data-suggestion="${escapeHtml(suggestion.text)}"
                    >
                        Apply
                    </button>
                </div>
            `).join('');

            setupApplySuggestionButtons();
        } else {
            suggestionsList.innerHTML = '<div class="text-gray-500 text-sm">No suggestions available</div>';
        }
    }

    function showReviewError(message) {
        const loading = document.getElementById('review-single-loading');
        const error = document.getElementById('review-single-error');

        loading.classList.add('hidden');
        error.classList.remove('hidden');

        document.getElementById('review-error-message').textContent = message;
    }

    function setupApplySuggestionButtons() {
        document.querySelectorAll('.apply-suggestion-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const suggestion = this.dataset.suggestion;
                await applySuggestion(currentReviewKey, suggestion, this);
            });
        });
    }

    async function applySuggestion(key, newTranslation, button) {
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Applying...';

        try {
            const response = await fetch(`/api/review/${fileId}/${language}/${encodeURIComponent(key)}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    translation: newTranslation,
                    state: 'translated',
                }),
            });

            if (!response.ok) throw new Error('Failed to apply');

            // Update the table row
            const row = document.querySelector(`tr[data-key="${CSS.escape(key)}"]`);
            const input = row?.querySelector('.translation-input');
            if (input) {
                input.value = newTranslation;
                input.dataset.original = newTranslation;
                input.dataset.translation = newTranslation;
            }

            // Update the review button's data-translation
            const reviewBtn = row?.querySelector('.review-single-btn');
            if (reviewBtn) {
                reviewBtn.dataset.translation = newTranslation;
            }

            // Update state badge to translated
            const stateBadge = row?.querySelector('.state-badge');
            if (stateBadge) {
                stateBadge.className = 'state-badge bg-emerald-600 text-white text-xs px-2 py-1 rounded';
                stateBadge.textContent = 'Translated';
            }

            // Close modal and show success
            document.getElementById('review-single-modal').classList.add('hidden');
            showToast('Suggestion applied successfully', 'success');

        } catch (err) {
            showToast(err.message, 'error');
            button.disabled = false;
            button.textContent = originalText;
        }
    }

    // Review modal close handlers
    document.getElementById('close-review-single')?.addEventListener('click', () => {
        document.getElementById('review-single-modal').classList.add('hidden');
    });

    document.getElementById('close-review-error')?.addEventListener('click', () => {
        document.getElementById('review-single-modal').classList.add('hidden');
    });

    // Close on background click
    document.getElementById('review-single-modal')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            e.currentTarget.classList.add('hidden');
        }
    });

    // Translate all untranslated
    document.getElementById('translate-all-btn').addEventListener('click', async () => {
        const btn = document.getElementById('translate-all-btn');
        const modal = document.getElementById('translate-modal');
        const progress = document.getElementById('translate-progress');
        const results = document.getElementById('translate-results');

        btn.disabled = true;
        modal.classList.remove('hidden');
        progress.classList.remove('hidden');
        results.classList.add('hidden');

        try {
            const response = await fetch(`/api/review/${fileId}/${language}/translate-all-untranslated`, {
                method: 'POST',
            });

            if (!response.ok) throw new Error('Failed to start translation');

            const data = await response.json();
            connectTranslateSSE(data.job_id);

        } catch (error) {
            showToast(error.message, 'error');
            modal.classList.add('hidden');
            btn.disabled = false;
        }
    });

    function connectTranslateSSE(jobId) {
        const eventSource = new EventSource(`/api/translate/${jobId}/stream`);

        eventSource.addEventListener('progress', (e) => {
            const data = JSON.parse(e.data);
            const percentage = data.lang_progress ? Math.round(data.lang_progress * 100) : 0;
            document.getElementById('translate-progress-bar').style.width = `${percentage}%`;
            document.getElementById('translate-percent').textContent = `${percentage}%`;
            document.getElementById('translate-status').textContent = data.message;
        });

        eventSource.addEventListener('complete', (e) => {
            eventSource.close();
            const data = JSON.parse(e.data);
            showTranslateResults(data);
        });

        eventSource.addEventListener('error', (e) => {
            eventSource.close();
            showToast('Translation failed', 'error');
            document.getElementById('translate-modal').classList.add('hidden');
            document.getElementById('translate-all-btn').disabled = false;
        });
    }

    function showTranslateResults(data) {
        document.getElementById('translate-progress').classList.add('hidden');
        document.getElementById('translate-results').classList.remove('hidden');

        const stats = data.stats_by_language?.[language] || {};
        document.getElementById('translate-green').textContent = stats.green_count || 0;
        document.getElementById('translate-yellow').textContent = stats.yellow_count || 0;

        document.getElementById('translate-all-btn').disabled = false;

        // Reload translations and sidebar
        loadTranslations(currentFilter);
        loadLanguageSidebar();
    }

    document.getElementById('close-translate').addEventListener('click', () => {
        document.getElementById('translate-modal').classList.add('hidden');
    });

    // Filter change
    document.querySelectorAll('input[name="state-filter"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            loadTranslations(e.target.value);
        });
    });

    // Verification modal (existing functionality)
    const verifyModal = document.getElementById('verify-modal');
    const verifyConfig = document.getElementById('verify-config');
    const verifyProgress = document.getElementById('verify-progress');
    const verifyResults = document.getElementById('verify-results');

    document.getElementById('verify-btn').addEventListener('click', () => {
        verifyModal.classList.remove('hidden');
        verifyConfig.classList.remove('hidden');
        verifyProgress.classList.add('hidden');
        verifyResults.classList.add('hidden');
    });

    document.getElementById('close-verify-modal').addEventListener('click', () => {
        verifyModal.classList.add('hidden');
    });

    document.getElementById('close-results').addEventListener('click', () => {
        verifyModal.classList.add('hidden');
    });

    document.getElementById('start-verify').addEventListener('click', async () => {
        verifyConfig.classList.add('hidden');
        verifyProgress.classList.remove('hidden');

        const reviewAll = document.getElementById('verify-all').checked;
        const limitInput = document.getElementById('verify-limit').value;
        const limit = limitInput ? parseInt(limitInput) : null;

        try {
            const response = await fetch(`/api/verify/${fileId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    language: language,
                    review_all: reviewAll,
                    limit: limit,
                }),
            });

            if (!response.ok) throw new Error('Failed to start verification');

            const data = await response.json();
            connectVerifySSE(data.job_id);

        } catch (error) {
            showToast(error.message, 'error');
            verifyModal.classList.add('hidden');
        }
    });

    function connectVerifySSE(jobId) {
        const eventSource = new EventSource(`/api/verify/${jobId}/stream`);

        eventSource.addEventListener('progress', (e) => {
            const data = JSON.parse(e.data);
            document.getElementById('verify-progress-bar').style.width = `${data.percentage}%`;
            document.getElementById('verify-percent').textContent = `${Math.round(data.percentage)}%`;
            document.getElementById('verify-status').textContent = data.message;
        });

        eventSource.addEventListener('complete', (e) => {
            eventSource.close();
            const data = JSON.parse(e.data);
            showVerifyResults(data.result);
        });

        eventSource.addEventListener('error', (e) => {
            eventSource.close();
            showToast('Verification failed', 'error');
            verifyModal.classList.add('hidden');
        });
    }

    function showVerifyResults(result) {
        verifyProgress.classList.add('hidden');
        verifyResults.classList.remove('hidden');

        document.getElementById('result-passed').textContent = result.passed;
        document.getElementById('result-attention').textContent = result.needs_attention;

        const issuesList = document.getElementById('issues-list');
        if (result.issues && result.issues.length > 0) {
            let html = '<div class="text-sm text-gray-400 mb-2">Issues found:</div>';
            for (const issue of result.issues) {
                html += `
                    <div class="bg-gray-750 rounded-lg p-3">
                        <code class="text-xs text-gray-400 break-all">${escapeHtml(issue.key)}</code>
                        <div class="text-yellow-400 text-sm mt-1">${issue.issues.join(', ')}</div>
                        ${issue.suggested_fix ? `<div class="text-emerald-400 text-sm mt-1">Suggested: ${escapeHtml(issue.suggested_fix)}</div>` : ''}
                    </div>
                `;
            }
            issuesList.innerHTML = html;
        } else {
            issuesList.innerHTML = '<div class="text-center text-gray-400">No issues found!</div>';
        }

        loadTranslations(currentFilter);
    }

    // Add Language Modal
    const addLanguageModal = document.getElementById('add-language-modal');
    const languageSelect = document.getElementById('language-select');
    const customLanguageInput = document.getElementById('custom-language-input');
    const customLanguageCode = document.getElementById('custom-language-code');
    const addLanguageError = document.getElementById('add-language-error');
    const confirmAddLanguageBtn = document.getElementById('confirm-add-language');

    document.getElementById('add-language-btn').addEventListener('click', () => {
        // Reset modal state
        languageSelect.value = '';
        customLanguageCode.value = '';
        customLanguageInput.classList.add('hidden');
        addLanguageError.classList.add('hidden');
        confirmAddLanguageBtn.disabled = true;
        addLanguageModal.classList.remove('hidden');
    });

    document.getElementById('cancel-add-language').addEventListener('click', () => {
        addLanguageModal.classList.add('hidden');
    });

    languageSelect.addEventListener('change', () => {
        const value = languageSelect.value;
        if (value === 'custom') {
            customLanguageInput.classList.remove('hidden');
            confirmAddLanguageBtn.disabled = !customLanguageCode.value.trim();
        } else {
            customLanguageInput.classList.add('hidden');
            confirmAddLanguageBtn.disabled = !value;
        }
        addLanguageError.classList.add('hidden');
    });

    customLanguageCode.addEventListener('input', () => {
        confirmAddLanguageBtn.disabled = !customLanguageCode.value.trim();
        addLanguageError.classList.add('hidden');
    });

    confirmAddLanguageBtn.addEventListener('click', async () => {
        const selectedValue = languageSelect.value;
        const langCode = selectedValue === 'custom'
            ? customLanguageCode.value.trim()
            : selectedValue;

        if (!langCode) return;

        confirmAddLanguageBtn.disabled = true;
        confirmAddLanguageBtn.innerHTML = `
            <svg class="animate-spin h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        `;

        try {
            const response = await fetch(`/api/languages/${fileId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ language: langCode }),
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to add language');
            }

            const result = await response.json();

            // Success - close modal and refresh sidebar
            addLanguageModal.classList.add('hidden');
            const appliedMsg = result.applied_to_disk ? ' (saved to file)' : '';
            showToast(`Added language: ${langCode}${appliedMsg}`, 'success');
            loadLanguageSidebar();

            // Navigate to the new language
            window.location.href = `/review/${langCode}`;

        } catch (error) {
            addLanguageError.textContent = error.message;
            addLanguageError.classList.remove('hidden');
            confirmAddLanguageBtn.disabled = false;
            confirmAddLanguageBtn.textContent = 'Add Language';
        }
    });

    // Initialize
    // Parse URL params for initial filter (e.g., ?filter=not_translated from badge link)
    const urlParams = new URLSearchParams(window.location.search);
    const initialFilter = urlParams.get('filter') || '';

    // Update radio button to match initial filter
    if (initialFilter) {
        const radio = document.querySelector(`input[name="state-filter"][value="${initialFilter}"]`);
        if (radio) radio.checked = true;
    }

    loadLanguageSidebar();
    loadTranslations(initialFilter);
</script>
{% endif %}
{% endblock %}
