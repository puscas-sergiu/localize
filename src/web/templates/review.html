{% extends "base.html" %}

{% block title %}{% if file_configured %}Review {{ language|upper }} - {{ metadata.original_name }}{% else %}Review - MintDeck Localizer{% endif %}{% endblock %}

{% block content %}
{% if not file_configured %}
<!-- No file configured state -->
<div class="flex flex-col items-center justify-center min-h-[60vh]">
    <svg class="h-20 w-20 text-gray-600 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
    </svg>
    <h1 class="text-2xl font-bold text-white mb-3">No File Configured</h1>
    <p class="text-gray-400 mb-8 text-center max-w-md">
        Configure a localization file to start reviewing and translating your strings.
    </p>
    <a href="/settings" class="bg-emerald-600 text-white px-8 py-3 rounded-lg font-medium hover:bg-emerald-700 transition-colors flex items-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
        <span>Go to Settings</span>
    </a>
</div>
{% else %}
<!-- Review page content -->
<div class="flex h-[calc(100vh-6rem)]">
    <!-- Left Sidebar: Language Navigation -->
    <div id="language-sidebar" class="w-56 bg-gray-800 border-r border-gray-700 flex-shrink-0 flex flex-col">
        <div class="px-4 py-3 border-b border-gray-700">
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Languages</h3>
        </div>
        <div id="language-list" class="py-2 flex-1 overflow-y-auto">
            <div class="px-4 py-2 text-gray-500 text-sm">Loading...</div>
        </div>
        <div class="p-3 border-t border-gray-700">
            <button
                id="add-language-btn"
                class="w-full bg-gray-700 text-gray-300 px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-600 transition-colors flex items-center justify-center space-x-2"
            >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                <span>Add Language</span>
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header with Step Indicator -->
        <div class="px-6 py-4 border-b border-gray-700 bg-gray-800">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-xl font-bold text-white">Review <span id="lang-title">{{ language|upper }}</span> Translations</h1>
                    <p class="text-sm text-gray-400 mt-1">{{ metadata.original_name }}</p>
                </div>
                <!-- More Menu (Download, View Last Results) -->
                <div class="relative">
                    <button id="more-menu-btn" class="bg-gray-700 text-gray-300 px-3 py-2 rounded-lg font-medium hover:bg-gray-600 transition-colors flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                        </svg>
                        <span>More</span>
                    </button>
                    <div id="more-menu-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-20">
                        <div class="py-1">
                            <a href="/api/files/{{ file_id }}/download" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">
                                <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                Download .xcstrings
                            </a>
                            <button id="view-last-results-menu-btn" class="hidden w-full flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white text-left">
                                <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                View Last LLM Results
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workflow Step Indicator -->
            <div id="workflow-steps" class="flex items-center justify-center space-x-2">
                <!-- Step 1: Setup -->
                <div class="flex items-center">
                    <div id="step-setup" class="flex items-center space-x-2 px-3 py-1.5 rounded-full bg-emerald-600/20 border border-emerald-600/50">
                        <div class="w-5 h-5 rounded-full bg-emerald-600 flex items-center justify-center">
                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <span class="text-emerald-400 text-sm font-medium">Setup</span>
                    </div>
                </div>
                <div class="w-8 h-0.5 bg-emerald-600"></div>

                <!-- Step 2: Translate -->
                <div class="flex items-center">
                    <div id="step-translate" class="flex items-center space-x-2 px-3 py-1.5 rounded-full bg-gray-700/50 border border-gray-600">
                        <div class="w-5 h-5 rounded-full bg-gray-600 flex items-center justify-center">
                            <span class="text-white text-xs font-bold">2</span>
                        </div>
                        <span class="text-gray-400 text-sm font-medium">Translate</span>
                        <span id="step-translate-count" class="hidden text-xs text-gray-500"></span>
                    </div>
                </div>
                <div id="connector-translate" class="w-8 h-0.5 bg-gray-600"></div>

                <!-- Step 3: Verify -->
                <div class="flex items-center">
                    <div id="step-verify" class="flex items-center space-x-2 px-3 py-1.5 rounded-full bg-gray-700/50 border border-gray-600">
                        <div class="w-5 h-5 rounded-full bg-gray-600 flex items-center justify-center">
                            <span class="text-white text-xs font-bold">3</span>
                        </div>
                        <span class="text-gray-400 text-sm font-medium">Verify</span>
                    </div>
                </div>
                <div id="connector-verify" class="w-8 h-0.5 bg-gray-600"></div>

                <!-- Step 4: Review -->
                <div class="flex items-center">
                    <div id="step-review" class="flex items-center space-x-2 px-3 py-1.5 rounded-full bg-gray-700/50 border border-gray-600">
                        <div class="w-5 h-5 rounded-full bg-gray-600 flex items-center justify-center">
                            <span class="text-white text-xs font-bold">4</span>
                        </div>
                        <span class="text-gray-400 text-sm font-medium">Review</span>
                        <span id="step-review-count" class="hidden text-xs text-gray-500"></span>
                    </div>
                </div>
                <div id="connector-review" class="w-8 h-0.5 bg-gray-600"></div>

                <!-- Step 5: Export -->
                <div class="flex items-center">
                    <div id="step-export" class="flex items-center space-x-2 px-3 py-1.5 rounded-full bg-gray-700/50 border border-gray-600">
                        <div class="w-5 h-5 rounded-full bg-gray-600 flex items-center justify-center">
                            <span class="text-white text-xs font-bold">5</span>
                        </div>
                        <span class="text-gray-400 text-sm font-medium">Export</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="px-6 py-0 bg-gray-800 border-b border-gray-700">
            <div class="flex items-center justify-between">
                <!-- Tab Buttons -->
                <nav class="flex" role="tablist">
                    <button
                        role="tab"
                        aria-selected="true"
                        id="tab-untranslated"
                        class="tab-btn px-5 py-3 text-sm font-medium border-b-2 transition-colors text-emerald-400 border-emerald-500 bg-emerald-900/10"
                        data-tab="untranslated"
                    >
                        <span class="flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            <span>Untranslated</span>
                            <span id="badge-untranslated" class="bg-emerald-600 text-white text-xs px-2 py-0.5 rounded-full font-bold">0</span>
                        </span>
                    </button>

                    <button
                        role="tab"
                        aria-selected="false"
                        id="tab-needs-review"
                        class="tab-btn px-5 py-3 text-sm font-medium border-b-2 transition-colors text-gray-400 border-transparent hover:text-gray-300"
                        data-tab="needs_review"
                    >
                        <span class="flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <span>Needs Review</span>
                            <span id="badge-needs-review" class="hidden bg-yellow-600 text-white text-xs px-2 py-0.5 rounded-full font-bold">0</span>
                        </span>
                    </button>

                    <button
                        role="tab"
                        aria-selected="false"
                        id="tab-all"
                        class="tab-btn px-5 py-3 text-sm font-medium border-b-2 transition-colors text-gray-400 border-transparent hover:text-gray-300"
                        data-tab="all"
                    >
                        <span class="flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                            </svg>
                            <span>All Strings</span>
                            <span id="badge-all" class="text-gray-500 text-xs">(0)</span>
                        </span>
                    </button>
                </nav>

                <!-- Tab-Contextual Actions -->
                <div id="tab-actions" class="flex items-center space-x-3 py-2">
                    <!-- Actions will be updated based on active tab -->
                    <button
                        id="translate-all-btn"
                        class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-emerald-700 transition-colors flex items-center space-x-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                        </svg>
                        <span>Translate All</span>
                    </button>
                    <button
                        id="verify-btn"
                        class="hidden bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center space-x-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        <span>Run LLM Check</span>
                    </button>
                    <button
                        id="view-last-results-btn"
                        class="hidden bg-purple-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-purple-700 transition-colors flex items-center space-x-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        <span>View Results</span>
                    </button>
                    <!-- Search (shown on All tab) -->
                    <div id="search-container" class="hidden">
                        <div class="relative">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input type="text"
                                   id="search-input"
                                   placeholder="Search..."
                                   class="bg-gray-700 border border-gray-600 rounded-lg pl-10 pr-4 py-2 text-white text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 w-64"
                                   oninput="handleSearch(this.value)">
                        </div>
                    </div>
                    <!-- State filter dropdown (shown on All tab) -->
                    <select id="state-filter-select" class="hidden bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm focus:ring-2 focus:ring-emerald-500">
                        <option value="">All states</option>
                        <option value="not_translated">Untranslated</option>
                        <option value="translated">Translated</option>
                        <option value="needs_review">Needs Review</option>
                        <option value="reviewed">Reviewed</option>
                        <option value="flagged">Flagged</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Translation Count -->
        <div class="px-6 py-2 bg-gray-750 border-b border-gray-700 flex items-center justify-end">
            <span id="translation-count" class="text-gray-400 text-sm"></span>
        </div>

        <!-- Translations Table -->
        <div class="flex-1 overflow-auto">
            <table class="w-full">
                <thead class="bg-gray-750 sticky top-0 z-10">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-1/4">Key</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-1/4">Source (EN)</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                            Translation (<span id="lang-header">{{ language|upper }}</span>)
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-28">State</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider w-20">Actions</th>
                    </tr>
                </thead>
                <tbody id="translations-tbody" class="divide-y divide-gray-700">
                    <!-- Loading state -->
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center">
                            <svg class="animate-spin mx-auto h-8 w-8 text-emerald-500" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- LLM Review Full-Screen Overlay -->
    <div id="llm-review-overlay" class="hidden fixed inset-0 z-50 bg-gray-900/95">
        <div class="absolute inset-4 md:inset-6 lg:inset-8 bg-gray-800 rounded-2xl border border-gray-700 flex flex-col overflow-hidden">

            <!-- Header with Stepper and Close Button -->
            <div class="px-6 py-4 border-b border-gray-700 bg-gray-750 flex items-center justify-between">
                <!-- Workflow Stepper -->
                <div class="flex items-center space-x-4">
                    <!-- Step 1: Translation (completed) -->
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <span class="text-emerald-400 font-medium">Translation</span>
                    </div>

                    <!-- Connector -->
                    <div class="w-12 h-0.5 bg-gray-600"></div>

                    <!-- Step 2: LLM Review (active) -->
                    <div class="flex items-center space-x-2">
                        <div id="step2-indicator" class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center">
                            <svg id="step2-spinner" class="hidden animate-spin w-5 h-5 text-white" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                            <span id="step2-number" class="text-white font-bold">2</span>
                        </div>
                        <span class="text-blue-400 font-medium">LLM Review</span>
                    </div>
                </div>

                <!-- Close Button -->
                <button id="close-llm-overlay" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-700 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Progress Section -->
            <div class="px-6 py-4 border-b border-gray-700 bg-gray-800">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-6">
                        <span id="batch-indicator" class="text-white font-medium">Batch 0 of 0</span>
                        <span id="reviewed-indicator" class="text-gray-400">0 of 0 strings reviewed</span>
                    </div>
                    <span id="overall-percent" class="text-blue-400 font-bold text-lg">0%</span>
                </div>
                <div class="bg-gray-700 rounded-full h-3">
                    <div id="overall-progress-bar" class="bg-blue-500 rounded-full h-3 transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="current-batch-status" class="text-sm text-gray-400 mt-2">Ready to start verification</div>
            </div>

            <!-- Summary Stats -->
            <div class="px-6 py-4 border-b border-gray-700 bg-gray-800">
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-gray-750 rounded-lg p-4 text-center">
                        <div class="text-3xl font-bold text-emerald-400" id="stats-passed">0</div>
                        <div class="text-sm text-gray-400 mt-1">Passed</div>
                    </div>
                    <div class="bg-gray-750 rounded-lg p-4 text-center">
                        <div class="text-3xl font-bold text-yellow-400" id="stats-attention">0</div>
                        <div class="text-sm text-gray-400 mt-1">Needs Attention</div>
                    </div>
                    <div class="bg-gray-750 rounded-lg p-4 text-center">
                        <div class="text-3xl font-bold text-amber-400" id="stats-flagged">0</div>
                        <div class="text-sm text-gray-400 mt-1">Flagged</div>
                    </div>
                </div>
            </div>

            <!-- Issues List (scrollable) -->
            <div class="flex-1 overflow-y-auto px-6 py-4 bg-gray-850" id="llm-issues-container">
                <!-- Initial state: Start button -->
                <div id="llm-start-section" class="flex flex-col items-center justify-center h-full">
                    <svg class="w-16 h-16 text-blue-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <h3 class="text-xl font-semibold text-white mb-2">LLM Review</h3>
                    <p class="text-gray-400 text-center max-w-md mb-6">
                        This will analyze all unreviewed translations using AI to identify potential issues and suggest improvements. Strings are processed in batches of 100.
                    </p>

                    <!-- Auto-continue toggle -->
                    <label class="flex items-center space-x-3 mb-6 cursor-pointer group">
                        <div class="relative">
                            <input type="checkbox" id="auto-continue-toggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:bg-blue-600 transition-colors"></div>
                            <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full transition-transform peer-checked:translate-x-5"></div>
                        </div>
                        <div>
                            <span class="text-white font-medium">Process all batches automatically</span>
                            <p class="text-xs text-gray-500">Review issues after all batches complete</p>
                        </div>
                    </label>

                    <button id="start-llm-review" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition-colors flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Start Verification</span>
                    </button>
                </div>

                <!-- Processing state -->
                <div id="llm-processing-section" class="hidden flex flex-col items-center justify-center h-full">
                    <svg class="animate-spin w-16 h-16 text-blue-400 mb-4" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <h3 class="text-xl font-semibold text-white mb-2">Analyzing Translations...</h3>
                    <p id="processing-status" class="text-gray-400">Processing batch...</p>
                </div>

                <!-- Issues list -->
                <div id="llm-issues-list" class="hidden space-y-4">
                    <!-- Issue cards will be inserted here -->
                </div>

                <!-- Empty state (no issues found) -->
                <div id="llm-no-issues" class="hidden flex flex-col items-center justify-center h-full">
                    <svg class="w-16 h-16 text-emerald-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="text-xl font-semibold text-white mb-2">All Clear!</h3>
                    <p class="text-gray-400">No issues found in this batch.</p>
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="px-6 py-4 border-t border-gray-700 bg-gray-750 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button id="cancel-llm-review" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                        Cancel Review
                    </button>
                    <div class="text-xs text-gray-500 hidden md:flex items-center space-x-3">
                        <span class="flex items-center"><kbd class="bg-gray-700 px-1.5 py-0.5 rounded text-gray-400">Tab</kbd><span class="ml-1">Navigate</span></span>
                        <span class="flex items-center"><kbd class="bg-gray-700 px-1.5 py-0.5 rounded text-gray-400">A</kbd><span class="ml-1">Apply</span></span>
                        <span class="flex items-center"><kbd class="bg-gray-700 px-1.5 py-0.5 rounded text-gray-400">D</kbd><span class="ml-1">Dismiss</span></span>
                        <span class="flex items-center"><kbd class="bg-gray-700 px-1.5 py-0.5 rounded text-gray-400">F</kbd><span class="ml-1">Flag</span></span>
                        <span class="flex items-center"><kbd class="bg-gray-700 px-1.5 py-0.5 rounded text-gray-400">Esc</kbd><span class="ml-1">Close</span></span>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <div id="apply-all-section" class="hidden">
                        <button id="apply-all-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                            <span>Apply All</span>
                            <span id="apply-all-badge" class="bg-emerald-800 px-2 py-0.5 rounded text-sm">0</span>
                        </button>
                    </div>
                    <button id="continue-llm-review" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                        Continue to Next Batch
                    </button>
                    <button id="finish-llm-review" class="hidden bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                        Finish Review
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Translation Progress Modal -->
    <div id="translate-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-lg w-full mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">Translating Untranslated Strings</h3>

            <div id="translate-progress" class="space-y-4">
                <div>
                    <div class="flex justify-between text-sm text-gray-400 mb-2">
                        <span id="translate-status">Starting translation...</span>
                        <span id="translate-percent">0%</span>
                    </div>
                    <div class="bg-gray-700 rounded-full h-3">
                        <div id="translate-progress-bar" class="bg-emerald-500 rounded-full h-3 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="translate-results" class="hidden space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-750 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-emerald-400" id="translate-green">0</div>
                        <div class="text-sm text-gray-400">High Quality</div>
                    </div>
                    <div class="bg-gray-750 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-yellow-400" id="translate-yellow">0</div>
                        <div class="text-sm text-gray-400">Needs Review</div>
                    </div>
                </div>

                <button
                    id="close-translate"
                    class="w-full bg-gray-700 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors"
                >
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Add Language Modal -->
    <div id="add-language-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">Add New Language</h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Select a language or enter a code</label>
                    <select
                        id="language-select"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-emerald-500 focus:border-emerald-500"
                    >
                        <option value="">-- Select a language --</option>
                        <option value="ar">Arabic (ar)</option>
                        <option value="zh-Hans">Chinese Simplified (zh-Hans)</option>
                        <option value="zh-Hant">Chinese Traditional (zh-Hant)</option>
                        <option value="cs">Czech (cs)</option>
                        <option value="da">Danish (da)</option>
                        <option value="nl">Dutch (nl)</option>
                        <option value="fi">Finnish (fi)</option>
                        <option value="el">Greek (el)</option>
                        <option value="he">Hebrew (he)</option>
                        <option value="hi">Hindi (hi)</option>
                        <option value="hu">Hungarian (hu)</option>
                        <option value="id">Indonesian (id)</option>
                        <option value="ja">Japanese (ja)</option>
                        <option value="ko">Korean (ko)</option>
                        <option value="ms">Malay (ms)</option>
                        <option value="nb">Norwegian Bokmal (nb)</option>
                        <option value="pl">Polish (pl)</option>
                        <option value="pt-BR">Portuguese Brazil (pt-BR)</option>
                        <option value="pt-PT">Portuguese Portugal (pt-PT)</option>
                        <option value="ru">Russian (ru)</option>
                        <option value="sk">Slovak (sk)</option>
                        <option value="sv">Swedish (sv)</option>
                        <option value="th">Thai (th)</option>
                        <option value="tr">Turkish (tr)</option>
                        <option value="uk">Ukrainian (uk)</option>
                        <option value="vi">Vietnamese (vi)</option>
                        <option value="custom">Other (enter code below)</option>
                    </select>
                </div>

                <div id="custom-language-input" class="hidden">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Custom language code</label>
                    <input
                        type="text"
                        id="custom-language-code"
                        placeholder="e.g., ca, bg, hr"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:ring-emerald-500 focus:border-emerald-500"
                    >
                    <p class="text-xs text-gray-500 mt-1">Use ISO 639-1 codes (e.g., 'ja') or BCP 47 tags (e.g., 'zh-Hans')</p>
                </div>

                <div id="add-language-error" class="hidden text-red-400 text-sm"></div>

                <div class="flex space-x-3 pt-4">
                    <button
                        id="cancel-add-language"
                        class="flex-1 bg-gray-700 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors"
                    >
                        Cancel
                    </button>
                    <button
                        id="confirm-add-language"
                        class="flex-1 bg-emerald-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        Add Language
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Single Translation Review Modal -->
    <div id="review-single-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-lg w-full mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">LLM Review</h3>

            <!-- Loading State -->
            <div id="review-single-loading" class="space-y-4">
                <div class="flex items-center justify-center py-8">
                    <svg class="animate-spin h-8 w-8 text-purple-500" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                </div>
                <p class="text-center text-gray-400">Analyzing translation...</p>
            </div>

            <!-- Results State -->
            <div id="review-single-results" class="hidden space-y-4">
                <!-- Current Translation -->
                <div class="bg-gray-750 rounded-lg p-3">
                    <div class="text-xs text-gray-500 uppercase mb-1">Current Translation</div>
                    <div id="review-current-translation" class="text-gray-300"></div>
                </div>

                <!-- Issues Section -->
                <div id="review-issues-section">
                    <div class="text-sm font-medium text-gray-400 mb-2">Issues Found</div>
                    <div id="review-issues-list" class="space-y-2">
                        <!-- Issues will be inserted here -->
                    </div>
                </div>

                <!-- No Issues Message -->
                <div id="review-no-issues" class="hidden">
                    <div class="flex items-center space-x-2 text-emerald-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>No issues found - translation looks good!</span>
                    </div>
                </div>

                <!-- Suggestions Section -->
                <div>
                    <div class="text-sm font-medium text-gray-400 mb-2">Suggestions</div>
                    <div id="review-suggestions-list" class="space-y-2">
                        <!-- Suggestions with Apply buttons will be inserted here -->
                    </div>
                </div>

                <!-- Close Button -->
                <button
                    id="close-review-single"
                    class="w-full bg-gray-700 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors mt-4"
                >
                    Close
                </button>
            </div>

            <!-- Error State -->
            <div id="review-single-error" class="hidden space-y-4">
                <div class="flex items-center space-x-2 text-red-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span id="review-error-message">Failed to review translation</span>
                </div>
                <button
                    id="close-review-error"
                    class="w-full bg-gray-700 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors"
                >
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if file_configured %}
<script>
    const fileId = '{{ file_id }}';
    let language = '{{ language }}';
    let translations = [];
    let currentFilter = '';
    let searchQuery = '';
    let activeTab = 'untranslated';

    // Tab counts for badges and step indicator
    let tabCounts = {
        untranslated: 0,
        needs_review: 0,
        flagged: 0,
        total: 0
    };

    function handleSearch(query) {
        searchQuery = query.toLowerCase().trim();
        renderTranslations();
    }

    // Language display names
    const languageNames = {
        'en': 'English',
        'de': 'German',
        'fr': 'French',
        'it': 'Italian',
        'es': 'Spanish',
        'ro': 'Romanian',
    };

    const flagEmojis = {
        'en': 'üá∫üá∏',
        'de': 'üá©üá™',
        'fr': 'üá´üá∑',
        'it': 'üáÆüáπ',
        'es': 'üá™üá∏',
        'ro': 'üá∑üá¥',
    };

    // Load language sidebar
    async function loadLanguageSidebar() {
        try {
            const response = await fetch(`/api/stats/${fileId}`);
            if (!response.ok) throw new Error('Failed to load stats');

            const stats = await response.json();
            const languageList = document.getElementById('language-list');

            let html = '';
            for (const lang of Object.keys(stats.coverage).sort()) {
                const coverage = stats.coverage[lang];
                const isActive = lang === language;
                const activeClass = isActive ? 'bg-emerald-600/20 border-l-2 border-emerald-500' : 'border-l-2 border-transparent';
                const colorClass = coverage.percentage >= 90 ? 'text-emerald-400' :
                                  coverage.percentage >= 50 ? 'text-yellow-400' : 'text-red-400';

                html += `
                    <a
                        href="/review/${lang}"
                        class="block px-4 py-3 hover:bg-gray-700 transition-colors ${activeClass}"
                    >
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-base">${flagEmojis[lang] || 'üåê'}</span>
                                <span class="text-white text-sm font-medium">${languageNames[lang] || lang.toUpperCase()}</span>
                            </div>
                            <span class="${colorClass} text-sm font-medium">${coverage.percentage}%</span>
                        </div>
                        <div class="mt-1 text-xs text-gray-500 pl-6">
                            ${coverage.translated}/${coverage.total}
                        </div>
                    </a>
                `;
            }

            languageList.innerHTML = html || '<div class="px-4 py-2 text-gray-500 text-sm">No languages found</div>';

        } catch (error) {
            console.error('Failed to load language sidebar:', error);
        }
    }

    // Load translations
    async function loadTranslations(stateFilter = '') {
        try {
            let url = `/api/review/${fileId}/${language}`;
            if (stateFilter) {
                url += `?state=${stateFilter}`;
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load translations');

            const data = await response.json();
            translations = data.translations;
            currentFilter = stateFilter;
            renderTranslations();
            // Update header badge with untranslated count
            window.updateUntranslatedBadge(fileId);

            // Also fetch all translations to calculate tab counts (if not already loading all)
            if (stateFilter !== '') {
                fetchTabCounts();
            } else {
                // Calculate counts from current data
                calculateTabCounts(translations);
            }

        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    // Fetch all translations to calculate tab badge counts
    async function fetchTabCounts() {
        try {
            const response = await fetch(`/api/review/${fileId}/${language}`);
            if (!response.ok) return;

            const data = await response.json();
            calculateTabCounts(data.translations);
        } catch (error) {
            console.error('Failed to fetch tab counts:', error);
        }
    }

    // Calculate tab counts from translations array
    function calculateTabCounts(allTranslations) {
        tabCounts.untranslated = 0;
        tabCounts.needs_review = 0;
        tabCounts.flagged = 0;
        tabCounts.total = allTranslations.length;

        for (const t of allTranslations) {
            if (t.state === 'not_translated' || !t.translation) {
                tabCounts.untranslated++;
            } else if (t.state === 'needs_review') {
                tabCounts.needs_review++;
            } else if (t.state === 'flagged') {
                tabCounts.flagged++;
            }
        }

        updateTabBadges();
    }

    function renderTranslations() {
        const tbody = document.getElementById('translations-tbody');
        const count = document.getElementById('translation-count');

        // Apply search filter
        let displayTranslations = translations;
        if (searchQuery) {
            displayTranslations = translations.filter(t =>
                t.key.toLowerCase().includes(searchQuery) ||
                t.source.toLowerCase().includes(searchQuery) ||
                (t.translation && t.translation.toLowerCase().includes(searchQuery))
            );
        }

        // Update count (show filtered vs total when searching)
        if (searchQuery && displayTranslations.length !== translations.length) {
            count.textContent = `${displayTranslations.length} of ${translations.length} strings`;
        } else {
            count.textContent = `${displayTranslations.length} strings`;
        }

        if (displayTranslations.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-12 text-center text-gray-400">
                        ${searchQuery ? 'No matches found' : 'No translations found'}
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';
        for (const t of displayTranslations) {
            const isUntranslated = t.state === 'not_translated' || !t.translation;
            const isReviewed = t.state === 'reviewed';
            const isFlagged = t.state === 'flagged';
            const stateColor = t.state === 'reviewed' ? 'bg-blue-600' :
                              t.state === 'flagged' ? 'bg-amber-600' :
                              t.state === 'translated' ? 'bg-emerald-600' :
                              t.state === 'needs_review' ? 'bg-yellow-600' :
                              t.state === 'not_translated' ? 'bg-gray-500' : 'bg-gray-600';
            const stateText = t.state === 'reviewed' ? 'Reviewed' :
                             t.state === 'flagged' ? 'Flagged' :
                             t.state === 'translated' ? 'Translated' :
                             t.state === 'needs_review' ? 'Needs Review' :
                             t.state === 'not_translated' ? 'New' : t.state;

            const rowBgClass = isUntranslated ? 'bg-amber-900/10' : (isReviewed ? 'bg-blue-900/5' : (isFlagged ? 'bg-amber-900/10' : ''));
            const rowBorderClass = isReviewed ? 'border-l-2 border-l-blue-500' : (isFlagged ? 'border-l-2 border-l-amber-500' : '');
            const inputBorderClass = isUntranslated ? 'border-dashed border-amber-500/50' : 'border-gray-600';

            html += `
                <tr class="${rowBgClass} ${rowBorderClass} hover:bg-gray-750 transition-colors" data-key="${escapeHtml(t.key)}">
                    <td class="px-4 py-3">
                        <code class="text-xs text-gray-400 break-all">${escapeHtml(t.key)}</code>
                    </td>
                    <td class="px-4 py-3 text-gray-300 text-sm">${escapeHtml(t.source)}</td>
                    <td class="px-4 py-3">
                        <div class="relative">
                            <input
                                type="text"
                                class="translation-input w-full bg-gray-700 border ${inputBorderClass} rounded px-3 py-2 text-white text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                value="${escapeHtml(t.translation)}"
                                placeholder="${isUntranslated ? 'Not translated' : ''}"
                                data-key="${escapeHtml(t.key)}"
                                data-original="${escapeHtml(t.translation)}"
                                data-source="${escapeHtml(t.source)}"
                            >
                            <div class="save-indicator hidden absolute right-2 top-1/2 -translate-y-1/2">
                                <svg class="animate-spin h-4 w-4 text-emerald-500" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="state-badge ${stateColor} text-white text-xs px-2 py-1 rounded">${stateText}</span>
                    </td>
                    <td class="px-4 py-3 text-right">
                        <div class="flex items-center justify-end space-x-1">
                        ${isUntranslated ? `
                            <button
                                class="translate-single-btn text-blue-400 hover:text-blue-300 p-1"
                                data-key="${escapeHtml(t.key)}"
                                data-source="${escapeHtml(t.source)}"
                                title="Auto-translate this string"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                                </svg>
                            </button>
                        ` : `
                            <button
                                class="review-single-btn text-purple-400 hover:text-purple-300 p-1"
                                data-key="${escapeHtml(t.key)}"
                                data-source="${escapeHtml(t.source)}"
                                data-translation="${escapeHtml(t.translation)}"
                                title="LLM Review"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                </svg>
                            </button>
                            ${!isReviewed ? `
                            <button
                                class="approve-btn text-emerald-400 hover:text-emerald-300 p-1"
                                data-key="${escapeHtml(t.key)}"
                                title="Mark as reviewed"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </button>
                            ` : ''}
                        `}
                        </div>
                    </td>
                </tr>
            `;
        }

        tbody.innerHTML = html;
        setupInlineEditing();
        setupTranslateSingleButtons();
        setupReviewSingleButtons();
        setupApproveButtons();
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Inline editing
    function setupInlineEditing() {
        document.querySelectorAll('.translation-input').forEach(input => {
            input.addEventListener('blur', async function() {
                const key = this.dataset.key;
                const original = this.dataset.original;
                const newValue = this.value.trim();

                if (newValue !== original && newValue !== '') {
                    await saveTranslation(key, newValue, this);
                }
            });

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur();
                } else if (e.key === 'Escape') {
                    this.value = this.dataset.original;
                    this.blur();
                }
            });
        });
    }

    async function saveTranslation(key, translation, inputElement) {
        const indicator = inputElement.parentElement.querySelector('.save-indicator');
        indicator?.classList.remove('hidden');

        try {
            const response = await fetch(`/api/review/${fileId}/${language}/${encodeURIComponent(key)}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    translation: translation,
                    state: 'translated',
                }),
            });

            if (!response.ok) throw new Error('Failed to save');

            inputElement.dataset.original = translation;

            // Update row styling
            const row = inputElement.closest('tr');
            row.classList.remove('bg-amber-900/10');
            inputElement.classList.remove('border-dashed', 'border-amber-500/50');
            inputElement.classList.add('border-gray-600');

            // Update state badge
            const stateBadge = row.querySelector('.state-badge');
            stateBadge.className = 'state-badge bg-emerald-600 text-white text-xs px-2 py-1 rounded';
            stateBadge.textContent = 'Translated';

            // Remove translate button if exists
            const translateBtn = row.querySelector('.translate-single-btn');
            translateBtn?.remove();

            showToast('Saved', 'success');

        } catch (error) {
            showToast(error.message, 'error');
            inputElement.value = inputElement.dataset.original;
        } finally {
            indicator?.classList.add('hidden');
        }
    }

    // Single string translation
    function setupTranslateSingleButtons() {
        document.querySelectorAll('.translate-single-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const key = this.dataset.key;
                const source = this.dataset.source;
                await autoTranslateSingle(key, source, this);
            });
        });
    }

    async function autoTranslateSingle(key, source, button) {
        const row = document.querySelector(`tr[data-key="${CSS.escape(key)}"]`);
        const input = row?.querySelector('.translation-input');

        // Show loading state
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `
            <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        `;

        try {
            const response = await fetch(`/api/review/${fileId}/${language}/translate-single`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ key, source }),
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Translation failed');
            }

            const data = await response.json();

            // Update the input field
            if (input) {
                input.value = data.translation;
                input.dataset.original = data.translation;
                input.classList.remove('border-dashed', 'border-amber-500/50');
                input.classList.add('border-gray-600');
            }

            // Update row styling
            row?.classList.remove('bg-amber-900/10');

            // Update state badge
            const stateBadge = row?.querySelector('.state-badge');
            if (stateBadge) {
                stateBadge.className = data.state === 'translated'
                    ? 'state-badge bg-emerald-600 text-white text-xs px-2 py-1 rounded'
                    : 'state-badge bg-yellow-600 text-white text-xs px-2 py-1 rounded';
                stateBadge.textContent = data.state === 'translated' ? 'Translated' : 'Needs Review';
            }

            // Remove translate button
            button.remove();

            showToast(`Translated via ${data.provider}`, 'success');

        } catch (error) {
            showToast(error.message, 'error');
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    // Manual approve buttons
    function setupApproveButtons() {
        document.querySelectorAll('.approve-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const key = this.dataset.key;
                await approveTranslation(key, this);
            });
        });
    }

    async function approveTranslation(key, button) {
        const row = document.querySelector(`tr[data-key="${CSS.escape(key)}"]`);
        const input = row?.querySelector('.translation-input');
        const translation = input?.value || input?.dataset.original;

        if (!translation) {
            showToast('No translation to approve', 'error');
            return;
        }

        // Show loading state
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `
            <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        `;

        try {
            const response = await fetch(`/api/review/${fileId}/${language}/${encodeURIComponent(key)}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    translation: translation,
                    state: 'reviewed',
                }),
            });

            if (!response.ok) throw new Error('Failed to approve');

            // Update state badge to reviewed
            const stateBadge = row?.querySelector('.state-badge');
            if (stateBadge) {
                stateBadge.className = 'state-badge bg-blue-600 text-white text-xs px-2 py-1 rounded';
                stateBadge.textContent = 'Reviewed';
            }

            // Update row styling
            row?.classList.remove('bg-amber-900/10');
            row?.classList.add('bg-blue-900/5', 'border-l-2', 'border-l-blue-500');

            // Remove approve button (no longer needed for reviewed items)
            button.remove();

            showToast('Marked as reviewed', 'success');

        } catch (error) {
            showToast(error.message, 'error');
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    // Single translation LLM review
    let currentReviewKey = null;

    function setupReviewSingleButtons() {
        document.querySelectorAll('.review-single-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const key = this.dataset.key;
                const source = this.dataset.source;
                const translation = this.dataset.translation;
                await reviewSingleTranslation(key, source, translation, this);
            });
        });
    }

    async function reviewSingleTranslation(key, source, translation, button) {
        currentReviewKey = key;

        const modal = document.getElementById('review-single-modal');
        const loading = document.getElementById('review-single-loading');
        const results = document.getElementById('review-single-results');
        const error = document.getElementById('review-single-error');

        // Show modal in loading state
        modal.classList.remove('hidden');
        loading.classList.remove('hidden');
        results.classList.add('hidden');
        error.classList.add('hidden');

        // Show loading state on button
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `
            <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
        `;

        try {
            const response = await fetch(`/api/review/${fileId}/${language}/review-single`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ key, source, translation }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Review failed');
            }

            const data = await response.json();
            showReviewResults(data);

        } catch (err) {
            showReviewError(err.message);
        } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    function showReviewResults(data) {
        const loading = document.getElementById('review-single-loading');
        const results = document.getElementById('review-single-results');
        const issuesSection = document.getElementById('review-issues-section');
        const noIssues = document.getElementById('review-no-issues');
        const issuesList = document.getElementById('review-issues-list');
        const suggestionsList = document.getElementById('review-suggestions-list');

        // Hide loading, show results
        loading.classList.add('hidden');
        results.classList.remove('hidden');

        // Show current translation
        document.getElementById('review-current-translation').textContent = data.original_translation;

        // Show issues or "no issues" message
        if (data.issues && data.issues.length > 0) {
            issuesSection.classList.remove('hidden');
            noIssues.classList.add('hidden');

            issuesList.innerHTML = data.issues.map(issue => `
                <div class="flex items-start space-x-2 text-yellow-400 text-sm">
                    <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <span>${escapeHtml(issue)}</span>
                </div>
            `).join('');
        } else {
            issuesSection.classList.add('hidden');
            noIssues.classList.remove('hidden');
        }

        // Show suggestions with Apply buttons
        if (data.suggestions && data.suggestions.length > 0) {
            suggestionsList.innerHTML = data.suggestions.map((suggestion, index) => `
                <div class="bg-gray-750 rounded-lg p-3 flex items-start justify-between space-x-3">
                    <div class="flex-1 min-w-0">
                        <div class="text-white break-words">${escapeHtml(suggestion.text)}</div>
                        <div class="text-xs text-gray-500 mt-1">${escapeHtml(suggestion.explanation)}</div>
                    </div>
                    <button
                        class="apply-suggestion-btn flex-shrink-0 bg-emerald-600 hover:bg-emerald-700 text-white text-xs px-3 py-1.5 rounded font-medium transition-colors"
                        data-suggestion="${escapeHtml(suggestion.text)}"
                    >
                        Apply
                    </button>
                </div>
            `).join('');

            setupApplySuggestionButtons();
        } else {
            suggestionsList.innerHTML = '<div class="text-gray-500 text-sm">No suggestions available</div>';
        }
    }

    function showReviewError(message) {
        const loading = document.getElementById('review-single-loading');
        const error = document.getElementById('review-single-error');

        loading.classList.add('hidden');
        error.classList.remove('hidden');

        document.getElementById('review-error-message').textContent = message;
    }

    function setupApplySuggestionButtons() {
        document.querySelectorAll('.apply-suggestion-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const suggestion = this.dataset.suggestion;
                await applySuggestion(currentReviewKey, suggestion, this);
            });
        });
    }

    async function applySuggestion(key, newTranslation, button) {
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Applying...';

        try {
            const response = await fetch(`/api/review/${fileId}/${language}/${encodeURIComponent(key)}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    translation: newTranslation,
                    state: 'reviewed',
                }),
            });

            if (!response.ok) throw new Error('Failed to apply');

            // Update the table row
            const row = document.querySelector(`tr[data-key="${CSS.escape(key)}"]`);
            const input = row?.querySelector('.translation-input');
            if (input) {
                input.value = newTranslation;
                input.dataset.original = newTranslation;
                input.dataset.translation = newTranslation;
            }

            // Update the review button's data-translation
            const reviewBtn = row?.querySelector('.review-single-btn');
            if (reviewBtn) {
                reviewBtn.dataset.translation = newTranslation;
            }

            // Update state badge to reviewed
            const stateBadge = row?.querySelector('.state-badge');
            if (stateBadge) {
                stateBadge.className = 'state-badge bg-blue-600 text-white text-xs px-2 py-1 rounded';
                stateBadge.textContent = 'Reviewed';
            }

            // Update row styling for reviewed state
            row?.classList.remove('bg-amber-900/10');
            row?.classList.add('bg-blue-900/5', 'border-l-2', 'border-l-blue-500');

            // Remove approve button (no longer needed for reviewed items)
            const approveBtn = row?.querySelector('.approve-btn');
            approveBtn?.remove();

            // Close modal and show success
            document.getElementById('review-single-modal').classList.add('hidden');
            showToast('Suggestion applied successfully', 'success');

        } catch (err) {
            showToast(err.message, 'error');
            button.disabled = false;
            button.textContent = originalText;
        }
    }

    // Review modal close handlers
    document.getElementById('close-review-single')?.addEventListener('click', () => {
        document.getElementById('review-single-modal').classList.add('hidden');
    });

    document.getElementById('close-review-error')?.addEventListener('click', () => {
        document.getElementById('review-single-modal').classList.add('hidden');
    });

    // Close on background click
    document.getElementById('review-single-modal')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            e.currentTarget.classList.add('hidden');
        }
    });

    // Translate all untranslated
    document.getElementById('translate-all-btn').addEventListener('click', async () => {
        const btn = document.getElementById('translate-all-btn');
        const modal = document.getElementById('translate-modal');
        const progress = document.getElementById('translate-progress');
        const results = document.getElementById('translate-results');

        btn.disabled = true;
        modal.classList.remove('hidden');
        progress.classList.remove('hidden');
        results.classList.add('hidden');

        try {
            const response = await fetch(`/api/review/${fileId}/${language}/translate-all-untranslated`, {
                method: 'POST',
            });

            if (!response.ok) throw new Error('Failed to start translation');

            const data = await response.json();
            connectTranslateSSE(data.job_id);

        } catch (error) {
            showToast(error.message, 'error');
            modal.classList.add('hidden');
            btn.disabled = false;
        }
    });

    function connectTranslateSSE(jobId) {
        const eventSource = new EventSource(`/api/translate/${jobId}/stream`);

        eventSource.addEventListener('progress', (e) => {
            const data = JSON.parse(e.data);
            const percentage = data.lang_progress ? Math.round(data.lang_progress * 100) : 0;
            document.getElementById('translate-progress-bar').style.width = `${percentage}%`;
            document.getElementById('translate-percent').textContent = `${percentage}%`;
            document.getElementById('translate-status').textContent = data.message;
        });

        eventSource.addEventListener('complete', (e) => {
            eventSource.close();
            const data = JSON.parse(e.data);
            showTranslateResults(data);
        });

        eventSource.addEventListener('error', (e) => {
            eventSource.close();
            showToast('Translation failed', 'error');
            document.getElementById('translate-modal').classList.add('hidden');
            document.getElementById('translate-all-btn').disabled = false;
        });
    }

    function showTranslateResults(data) {
        document.getElementById('translate-progress').classList.add('hidden');
        document.getElementById('translate-results').classList.remove('hidden');

        const stats = data.stats_by_language?.[language] || {};
        document.getElementById('translate-green').textContent = stats.green_count || 0;
        document.getElementById('translate-yellow').textContent = stats.yellow_count || 0;

        document.getElementById('translate-all-btn').disabled = false;

        // Reload translations and sidebar
        loadTranslations(currentFilter);
        loadLanguageSidebar();
    }

    document.getElementById('close-translate').addEventListener('click', () => {
        document.getElementById('translate-modal').classList.add('hidden');
    });

    // Note: Filter radio buttons removed - now using tab navigation

    // ==========================================
    // LLM Review Full-Screen Overlay
    // ==========================================

    // State tracking
    let llmReviewState = {
        nextOffset: 0,
        totalUnreviewed: 0,
        processedBatches: 0,
        totalBatches: 0,
        cumulativePassed: 0,
        cumulativeAttention: 0,
        cumulativeFlagged: 0,
        currentIssues: [],
        allIssues: [],  // Accumulate all issues across batches in auto mode
        isProcessing: false,
        autoMode: true,  // Auto-continue through batches
        lastResults: null  // Store last results for re-viewing
    };

    // DOM element references
    const llmOverlay = document.getElementById('llm-review-overlay');

    // Open overlay when "Run LLM Verification" is clicked
    document.getElementById('verify-btn').addEventListener('click', () => {
        openLLMReviewOverlay();
    });

    function openLLMReviewOverlay() {
        // Reset state
        llmReviewState = {
            nextOffset: 0,
            totalUnreviewed: 0,
            processedBatches: 0,
            totalBatches: 0,
            cumulativePassed: 0,
            cumulativeAttention: 0,
            cumulativeFlagged: 0,
            currentIssues: [],
            allIssues: [],
            isProcessing: false,
            autoMode: true
        };

        // Reset UI elements
        document.getElementById('batch-indicator').textContent = 'Batch 0 of 0';
        document.getElementById('reviewed-indicator').textContent = '0 of 0 strings reviewed';
        document.getElementById('overall-percent').textContent = '0%';
        document.getElementById('overall-progress-bar').style.width = '0%';
        document.getElementById('current-batch-status').textContent = 'Ready to start verification';
        document.getElementById('stats-passed').textContent = '0';
        document.getElementById('stats-attention').textContent = '0';
        document.getElementById('stats-flagged').textContent = '0';

        // Show start section, hide others
        document.getElementById('llm-start-section').classList.remove('hidden');
        document.getElementById('llm-processing-section').classList.add('hidden');
        document.getElementById('llm-issues-list').classList.add('hidden');
        document.getElementById('llm-no-issues').classList.add('hidden');

        // Reset footer buttons
        document.getElementById('apply-all-section').classList.add('hidden');
        document.getElementById('continue-llm-review').classList.add('hidden');
        document.getElementById('finish-llm-review').classList.add('hidden');

        // Reset step indicator
        document.getElementById('step2-spinner').classList.add('hidden');
        document.getElementById('step2-number').classList.remove('hidden');

        // Show overlay
        llmOverlay.classList.remove('hidden');
    }

    function closeLLMReviewOverlay(force = false) {
        // Check if there are pending issues that haven't been addressed
        const pendingIssues = llmReviewState.currentIssues.length;

        if (!force && pendingIssues > 0) {
            const confirmed = confirm(
                `You have ${pendingIssues} unresolved issue${pendingIssues > 1 ? 's' : ''} with suggestions.\n\n` +
                `Close anyway? You can re-open the results using "View Last Results" button.`
            );
            if (!confirmed) return;
        }

        // Save results so they can be re-viewed
        if (llmReviewState.allIssues.length > 0 || llmReviewState.currentIssues.length > 0) {
            llmReviewState.lastResults = {
                issues: llmReviewState.autoMode ? [...llmReviewState.allIssues] : [...llmReviewState.currentIssues],
                passed: llmReviewState.cumulativePassed,
                attention: llmReviewState.cumulativeAttention,
                flagged: llmReviewState.cumulativeFlagged,
                total: llmReviewState.totalUnreviewed
            };
            // Show the "View Last Results" button
            document.getElementById('view-last-results-btn')?.classList.remove('hidden');
        }

        llmOverlay.classList.add('hidden');
        // Refresh the main table and sidebar
        loadTranslations(currentFilter);
        loadLanguageSidebar();
    }

    // Close overlay handlers
    document.getElementById('close-llm-overlay').addEventListener('click', () => closeLLMReviewOverlay(false));
    document.getElementById('cancel-llm-review').addEventListener('click', () => closeLLMReviewOverlay(false));

    // View Last Results button
    document.getElementById('view-last-results-btn').addEventListener('click', () => {
        if (!llmReviewState.lastResults) return;

        const results = llmReviewState.lastResults;

        // Restore state from last results
        llmReviewState.cumulativePassed = results.passed;
        llmReviewState.cumulativeAttention = results.attention;
        llmReviewState.cumulativeFlagged = results.flagged;
        llmReviewState.totalUnreviewed = results.total;
        llmReviewState.currentIssues = results.issues.filter(i => i.suggested_fix);
        llmReviewState.allIssues = results.issues;
        llmReviewState.autoMode = true;
        llmReviewState.processedBatches = Math.ceil(results.total / 100);
        llmReviewState.totalBatches = llmReviewState.processedBatches;
        llmReviewState.nextOffset = results.total;

        // Update UI elements
        document.getElementById('batch-indicator').textContent = `Batch ${llmReviewState.processedBatches} of ${llmReviewState.totalBatches}`;
        document.getElementById('reviewed-indicator').textContent = `${results.total} of ${results.total} strings reviewed`;
        document.getElementById('overall-percent').textContent = '100%';
        document.getElementById('overall-progress-bar').style.width = '100%';
        document.getElementById('current-batch-status').textContent = `Viewing saved results. ${results.issues.length} issues found.`;
        document.getElementById('stats-passed').textContent = results.passed;
        document.getElementById('stats-attention').textContent = results.attention;
        document.getElementById('stats-flagged').textContent = results.flagged;

        // Hide start section, show results
        document.getElementById('llm-start-section').classList.add('hidden');
        document.getElementById('llm-processing-section').classList.add('hidden');
        document.getElementById('llm-no-issues').classList.add('hidden');

        // Render issues
        if (results.issues.length > 0) {
            renderLLMIssueCards(results.issues);
            document.getElementById('llm-issues-list').classList.remove('hidden');

            if (llmReviewState.currentIssues.length > 0) {
                document.getElementById('apply-all-section').classList.remove('hidden');
                document.getElementById('apply-all-badge').textContent = llmReviewState.currentIssues.length;
            }
        } else {
            document.getElementById('llm-issues-list').classList.add('hidden');
            document.getElementById('llm-no-issues').classList.remove('hidden');
        }

        // Show finish button, hide continue
        document.getElementById('continue-llm-review').classList.add('hidden');
        document.getElementById('finish-llm-review').classList.remove('hidden');

        // Reset step indicator
        document.getElementById('step2-spinner').classList.add('hidden');
        document.getElementById('step2-number').classList.remove('hidden');

        // Show overlay
        llmOverlay.classList.remove('hidden');
    });

    // Start verification
    document.getElementById('start-llm-review').addEventListener('click', () => {
        // Read auto-continue toggle state
        llmReviewState.autoMode = document.getElementById('auto-continue-toggle').checked;
        llmReviewState.allIssues = []; // Reset accumulated issues
        startLLMVerification(0);
    });

    // Continue to next batch
    document.getElementById('continue-llm-review').addEventListener('click', () => {
        startLLMVerification(llmReviewState.nextOffset);
    });

    // Finish review (force close, no confirmation needed)
    document.getElementById('finish-llm-review').addEventListener('click', () => closeLLMReviewOverlay(true));

    async function startLLMVerification(offset = 0) {
        llmReviewState.isProcessing = true;

        // Show processing state
        document.getElementById('llm-start-section').classList.add('hidden');
        document.getElementById('llm-processing-section').classList.remove('hidden');
        document.getElementById('llm-issues-list').classList.add('hidden');
        document.getElementById('llm-no-issues').classList.add('hidden');

        // Show spinner in step indicator
        document.getElementById('step2-spinner').classList.remove('hidden');
        document.getElementById('step2-number').classList.add('hidden');

        // Hide action buttons during processing
        document.getElementById('continue-llm-review').classList.add('hidden');
        document.getElementById('finish-llm-review').classList.add('hidden');

        document.getElementById('current-batch-status').textContent = 'Starting verification...';
        document.getElementById('processing-status').textContent = 'Processing batch...';

        // Clear issues list for new batch
        document.getElementById('llm-issues-list').innerHTML = '';

        try {
            const response = await fetch(`/api/verify/${fileId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    language: language,
                    offset: offset,
                }),
            });

            if (!response.ok) throw new Error('Failed to start verification');

            const data = await response.json();
            connectLLMVerifySSE(data.job_id);

        } catch (error) {
            showToast(error.message, 'error');
            llmReviewState.isProcessing = false;
            document.getElementById('step2-spinner').classList.add('hidden');
            document.getElementById('step2-number').classList.remove('hidden');
            document.getElementById('llm-processing-section').classList.add('hidden');
            document.getElementById('llm-start-section').classList.remove('hidden');
        }
    }

    function connectLLMVerifySSE(jobId) {
        const eventSource = new EventSource(`/api/verify/${jobId}/stream`);

        eventSource.addEventListener('progress', (e) => {
            const data = JSON.parse(e.data);
            document.getElementById('processing-status').textContent = data.message;
            document.getElementById('current-batch-status').textContent = data.message;
        });

        eventSource.addEventListener('complete', (e) => {
            eventSource.close();
            const data = JSON.parse(e.data);
            showLLMVerifyResults(data.result);
        });

        eventSource.addEventListener('error', (e) => {
            eventSource.close();
            showToast('Verification failed', 'error');
            llmReviewState.isProcessing = false;
            document.getElementById('step2-spinner').classList.add('hidden');
            document.getElementById('step2-number').classList.remove('hidden');
            document.getElementById('llm-processing-section').classList.add('hidden');
            document.getElementById('llm-start-section').classList.remove('hidden');
        });
    }

    function showLLMVerifyResults(result) {
        // Update state
        llmReviewState.nextOffset = result.next_offset || 0;
        llmReviewState.totalUnreviewed = result.total_unreviewed || 0;
        llmReviewState.processedBatches++;

        // Calculate total batches (100 per batch)
        const batchSize = 100;
        llmReviewState.totalBatches = Math.ceil(llmReviewState.totalUnreviewed / batchSize);

        // Accumulate counts
        llmReviewState.cumulativePassed += result.passed || 0;
        llmReviewState.cumulativeAttention += result.needs_attention || 0;

        // Store issues - accumulate in auto mode
        const newIssues = result.issues || [];
        if (llmReviewState.autoMode) {
            // Accumulate all issues across batches
            llmReviewState.allIssues = [...llmReviewState.allIssues, ...newIssues];
        }
        llmReviewState.currentIssues = newIssues.filter(issue => issue.suggested_fix);

        // Update progress indicators
        updateLLMProgressUI();

        // Update stats
        document.getElementById('stats-passed').textContent = llmReviewState.cumulativePassed;
        document.getElementById('stats-attention').textContent = llmReviewState.cumulativeAttention;
        document.getElementById('stats-flagged').textContent = llmReviewState.cumulativeFlagged;

        // AUTO MODE: Continue to next batch automatically
        if (llmReviewState.autoMode && result.has_more) {
            document.getElementById('current-batch-status').textContent = `Processing batch ${llmReviewState.processedBatches + 1} of ${llmReviewState.totalBatches}...`;
            // Small delay to allow UI to update before starting next batch
            setTimeout(() => {
                startLLMVerification(llmReviewState.nextOffset);
            }, 100);
            return;
        }

        // MANUAL MODE or ALL BATCHES COMPLETE: Show results
        llmReviewState.isProcessing = false;

        // Hide processing, show results
        document.getElementById('llm-processing-section').classList.add('hidden');
        document.getElementById('step2-spinner').classList.add('hidden');
        document.getElementById('step2-number').classList.remove('hidden');

        // In auto mode, use all accumulated issues; in manual mode, use current batch issues
        const issuesToShow = llmReviewState.autoMode ? llmReviewState.allIssues : newIssues;
        const issuesWithFixes = issuesToShow.filter(issue => issue.suggested_fix);

        // Update currentIssues for Apply All functionality
        if (llmReviewState.autoMode) {
            llmReviewState.currentIssues = issuesWithFixes;
        }

        // Show issues or no-issues state
        if (issuesToShow.length > 0) {
            renderLLMIssueCards(issuesToShow);
            document.getElementById('llm-issues-list').classList.remove('hidden');
            document.getElementById('llm-no-issues').classList.add('hidden');

            // Show Apply All if there are suggestions
            if (issuesWithFixes.length > 0) {
                document.getElementById('apply-all-section').classList.remove('hidden');
                document.getElementById('apply-all-badge').textContent = issuesWithFixes.length;
            }
        } else {
            document.getElementById('llm-issues-list').classList.add('hidden');
            document.getElementById('llm-no-issues').classList.remove('hidden');
            document.getElementById('apply-all-section').classList.add('hidden');
        }

        // Show Continue or Finish button
        if (result.has_more) {
            // Manual mode with more batches
            document.getElementById('continue-llm-review').classList.remove('hidden');
            document.getElementById('finish-llm-review').classList.add('hidden');
            document.getElementById('current-batch-status').textContent = `Batch complete. ${llmReviewState.totalUnreviewed - llmReviewState.nextOffset} strings remaining.`;
        } else {
            // All batches complete
            document.getElementById('continue-llm-review').classList.add('hidden');
            document.getElementById('finish-llm-review').classList.remove('hidden');
            if (llmReviewState.autoMode) {
                document.getElementById('current-batch-status').textContent = `All ${llmReviewState.totalUnreviewed} strings reviewed! Found ${llmReviewState.allIssues.length} issues.`;
            } else {
                document.getElementById('current-batch-status').textContent = 'All strings have been reviewed!';
            }
        }

        // Refresh main table in background
        loadTranslations(currentFilter);
    }

    function updateLLMProgressUI() {
        const reviewed = llmReviewState.nextOffset;
        const total = llmReviewState.totalUnreviewed;
        const percentage = total > 0 ? Math.round((reviewed / total) * 100) : 0;

        document.getElementById('batch-indicator').textContent = `Batch ${llmReviewState.processedBatches} of ${llmReviewState.totalBatches || '?'}`;
        document.getElementById('reviewed-indicator').textContent = `${reviewed} of ${total} strings reviewed`;
        document.getElementById('overall-percent').textContent = `${percentage}%`;
        document.getElementById('overall-progress-bar').style.width = `${percentage}%`;
    }

    function renderLLMIssueCards(issues) {
        const container = document.getElementById('llm-issues-list');
        let html = '';

        for (const issue of issues) {
            html += `
                <div class="llm-issue-card bg-gray-750 rounded-lg p-5 border border-gray-600 transition-all duration-300" data-key="${escapeHtml(issue.key)}">
                    <!-- Key -->
                    <div class="mb-3">
                        <span class="text-xs text-gray-500 uppercase tracking-wider">Key</span>
                        <code class="block text-sm text-gray-300 mt-1 break-all">${escapeHtml(issue.key)}</code>
                    </div>

                    <!-- Source and Current Translation -->
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <span class="text-xs text-gray-500 uppercase tracking-wider">Source (EN)</span>
                            <p class="text-base text-gray-200 mt-1">${escapeHtml(issue.source || '')}</p>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500 uppercase tracking-wider">Current Translation</span>
                            <p class="text-base text-white mt-1">${escapeHtml(issue.translation || '')}</p>
                        </div>
                    </div>

                    <!-- Issues Found -->
                    <div class="mb-4">
                        <span class="text-xs text-gray-500 uppercase tracking-wider">Issues Found</span>
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${issue.issues.map(i => `
                                <span class="inline-flex items-center px-2.5 py-1 rounded text-sm bg-yellow-900/30 text-yellow-400 border border-yellow-700/50">
                                    <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                    ${escapeHtml(i)}
                                </span>
                            `).join('')}
                        </div>
                    </div>

                    ${issue.suggested_fix ? `
                    <!-- Suggested Fix -->
                    <div class="mb-4 p-3 bg-emerald-900/20 rounded-lg border border-emerald-700/30">
                        <span class="text-xs text-emerald-500 uppercase tracking-wider">Suggested Fix</span>
                        <p class="text-base text-emerald-300 mt-1">${escapeHtml(issue.suggested_fix)}</p>
                    </div>
                    ` : ''}

                    <!-- Action Buttons -->
                    <div class="flex items-center justify-end space-x-3 pt-3 border-t border-gray-600">
                        ${issue.suggested_fix ? `
                        <button
                            class="llm-apply-btn bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2"
                            data-key="${escapeHtml(issue.key)}"
                            data-suggestion="${escapeHtml(issue.suggested_fix)}"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span>Apply</span>
                        </button>
                        ` : ''}
                        <button
                            class="llm-dismiss-btn bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2"
                            data-key="${escapeHtml(issue.key)}"
                            data-translation="${escapeHtml(issue.translation || '')}"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            <span>Dismiss</span>
                        </button>
                        <button
                            class="llm-flag-btn bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2"
                            data-key="${escapeHtml(issue.key)}"
                            data-translation="${escapeHtml(issue.translation || '')}"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path>
                            </svg>
                            <span>Flag</span>
                        </button>
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;
        setupLLMIssueButtons();
    }

    function setupLLMIssueButtons() {
        // Apply buttons
        document.querySelectorAll('.llm-apply-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const key = this.dataset.key;
                const suggestion = this.dataset.suggestion;
                await handleLLMApply(key, suggestion, this);
            });
        });

        // Dismiss buttons
        document.querySelectorAll('.llm-dismiss-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const key = this.dataset.key;
                const translation = this.dataset.translation;
                await handleLLMDismiss(key, translation, this);
            });
        });

        // Flag buttons
        document.querySelectorAll('.llm-flag-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const key = this.dataset.key;
                const translation = this.dataset.translation;
                await handleLLMFlag(key, translation, this);
            });
        });
    }

    async function handleLLMApply(key, newTranslation, button) {
        const card = button.closest('.llm-issue-card');
        const originalText = button.querySelector('span').textContent;
        button.disabled = true;
        button.querySelector('span').textContent = 'Applying...';

        try {
            const response = await fetch(`/api/review/${fileId}/${language}/${encodeURIComponent(key)}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    translation: newTranslation,
                    state: 'reviewed',
                }),
            });

            if (!response.ok) throw new Error('Failed to apply');

            // Update stats
            llmReviewState.cumulativeAttention--;
            llmReviewState.cumulativePassed++;
            document.getElementById('stats-passed').textContent = llmReviewState.cumulativePassed;
            document.getElementById('stats-attention').textContent = llmReviewState.cumulativeAttention;

            // Remove from current issues
            llmReviewState.currentIssues = llmReviewState.currentIssues.filter(i => i.key !== key);
            updateApplyAllBadge();

            // Animate card removal
            card.style.opacity = '0';
            card.style.transform = 'translateX(20px)';
            setTimeout(() => card.remove(), 300);

            showToast('Suggestion applied', 'success');

        } catch (error) {
            button.disabled = false;
            button.querySelector('span').textContent = originalText;
            showToast(error.message, 'error');
        }
    }

    async function handleLLMDismiss(key, currentTranslation, button) {
        const card = button.closest('.llm-issue-card');
        const originalText = button.querySelector('span').textContent;
        button.disabled = true;
        button.querySelector('span').textContent = 'Dismissing...';

        try {
            const response = await fetch(`/api/review/${fileId}/${language}/${encodeURIComponent(key)}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    translation: currentTranslation,
                    state: 'reviewed',
                }),
            });

            if (!response.ok) throw new Error('Failed to dismiss');

            // Update stats (move from attention to passed)
            llmReviewState.cumulativeAttention--;
            llmReviewState.cumulativePassed++;
            document.getElementById('stats-passed').textContent = llmReviewState.cumulativePassed;
            document.getElementById('stats-attention').textContent = llmReviewState.cumulativeAttention;

            // Remove from current issues
            llmReviewState.currentIssues = llmReviewState.currentIssues.filter(i => i.key !== key);
            updateApplyAllBadge();

            // Animate card removal
            card.style.opacity = '0';
            card.style.transform = 'translateX(20px)';
            setTimeout(() => card.remove(), 300);

            showToast('Issue dismissed', 'success');

        } catch (error) {
            button.disabled = false;
            button.querySelector('span').textContent = originalText;
            showToast(error.message, 'error');
        }
    }

    async function handleLLMFlag(key, currentTranslation, button) {
        const card = button.closest('.llm-issue-card');
        const originalText = button.querySelector('span').textContent;
        button.disabled = true;
        button.querySelector('span').textContent = 'Flagging...';

        try {
            const response = await fetch(`/api/review/${fileId}/${language}/${encodeURIComponent(key)}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    translation: currentTranslation,
                    state: 'flagged',
                }),
            });

            if (!response.ok) throw new Error('Failed to flag');

            // Update stats (move from attention to flagged)
            llmReviewState.cumulativeAttention--;
            llmReviewState.cumulativeFlagged++;
            document.getElementById('stats-attention').textContent = llmReviewState.cumulativeAttention;
            document.getElementById('stats-flagged').textContent = llmReviewState.cumulativeFlagged;

            // Remove from current issues
            llmReviewState.currentIssues = llmReviewState.currentIssues.filter(i => i.key !== key);
            updateApplyAllBadge();

            // Update card styling to show flagged
            card.classList.add('border-amber-500', 'bg-amber-900/20');
            card.style.opacity = '0.6';

            // Disable all buttons on the card
            card.querySelectorAll('button').forEach(btn => btn.disabled = true);
            button.querySelector('span').textContent = 'Flagged';

            showToast('Flagged for review', 'success');

        } catch (error) {
            button.disabled = false;
            button.querySelector('span').textContent = originalText;
            showToast(error.message, 'error');
        }
    }

    function updateApplyAllBadge() {
        const applyAllSection = document.getElementById('apply-all-section');
        const badge = document.getElementById('apply-all-badge');

        if (llmReviewState.currentIssues.length > 0) {
            applyAllSection.classList.remove('hidden');
            badge.textContent = llmReviewState.currentIssues.length;
        } else {
            applyAllSection.classList.add('hidden');
        }
    }

    // Apply All button
    document.getElementById('apply-all-btn').addEventListener('click', async () => {
        const btn = document.getElementById('apply-all-btn');
        btn.disabled = true;
        const originalHTML = btn.innerHTML;

        const total = llmReviewState.currentIssues.length;
        let applied = 0;
        let failed = 0;

        for (const issue of [...llmReviewState.currentIssues]) {
            btn.innerHTML = `<span>Applying ${applied + 1}/${total}...</span>`;

            try {
                const response = await fetch(`/api/review/${fileId}/${language}/${encodeURIComponent(issue.key)}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        translation: issue.suggested_fix,
                        state: 'reviewed',
                    }),
                });

                if (response.ok) {
                    applied++;
                    llmReviewState.cumulativeAttention--;
                    llmReviewState.cumulativePassed++;

                    // Remove the card
                    const card = document.querySelector(`.llm-issue-card[data-key="${CSS.escape(issue.key)}"]`);
                    if (card) {
                        card.style.opacity = '0';
                        card.style.transform = 'translateX(20px)';
                    }
                } else {
                    failed++;
                }
            } catch (error) {
                failed++;
            }
        }

        // Update stats
        document.getElementById('stats-passed').textContent = llmReviewState.cumulativePassed;
        document.getElementById('stats-attention').textContent = llmReviewState.cumulativeAttention;

        // Clear issues
        llmReviewState.currentIssues = [];

        // Update UI
        btn.innerHTML = `<span>All Applied!</span>`;
        document.getElementById('apply-all-badge').textContent = '0';

        setTimeout(() => {
            document.getElementById('apply-all-section').classList.add('hidden');
            btn.disabled = false;
            btn.innerHTML = originalHTML;

            // Remove all cards with animation complete
            document.querySelectorAll('.llm-issue-card').forEach(card => card.remove());

            // Show no issues state
            document.getElementById('llm-issues-list').classList.add('hidden');
            document.getElementById('llm-no-issues').classList.remove('hidden');
        }, 500);

        // Reload translations
        loadTranslations(currentFilter);

        if (failed > 0) {
            showToast(`Applied ${applied} suggestions, ${failed} failed`, 'warning');
        } else {
            showToast(`Successfully applied ${applied} suggestions`, 'success');
        }
    });

    // Keyboard navigation for LLM Review overlay
    document.addEventListener('keydown', (e) => {
        // Only handle when overlay is visible
        if (llmOverlay.classList.contains('hidden')) return;

        // Escape to close
        if (e.key === 'Escape') {
            closeLLMReviewOverlay();
            return;
        }

        // Only handle card navigation when there are cards
        const cards = document.querySelectorAll('.llm-issue-card:not([style*="opacity: 0"])');
        if (cards.length === 0) return;

        // Get currently focused card
        const focusedCard = document.querySelector('.llm-issue-card.ring-2');
        let currentIndex = focusedCard ? Array.from(cards).indexOf(focusedCard) : -1;

        // Tab / Shift+Tab to navigate between cards
        if (e.key === 'Tab') {
            e.preventDefault();
            if (e.shiftKey) {
                currentIndex = currentIndex <= 0 ? cards.length - 1 : currentIndex - 1;
            } else {
                currentIndex = currentIndex >= cards.length - 1 ? 0 : currentIndex + 1;
            }

            // Remove focus from previous card
            cards.forEach(card => card.classList.remove('ring-2', 'ring-blue-500'));

            // Focus new card
            cards[currentIndex].classList.add('ring-2', 'ring-blue-500');
            cards[currentIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        // Only handle action keys if a card is focused
        if (!focusedCard) return;

        // Enter or A = Apply
        if (e.key === 'Enter' || e.key === 'a' || e.key === 'A') {
            const applyBtn = focusedCard.querySelector('.llm-apply-btn');
            if (applyBtn && !applyBtn.disabled) {
                e.preventDefault();
                applyBtn.click();
            }
            return;
        }

        // D = Dismiss
        if (e.key === 'd' || e.key === 'D') {
            const dismissBtn = focusedCard.querySelector('.llm-dismiss-btn');
            if (dismissBtn && !dismissBtn.disabled) {
                e.preventDefault();
                dismissBtn.click();
            }
            return;
        }

        // F = Flag
        if (e.key === 'f' || e.key === 'F') {
            const flagBtn = focusedCard.querySelector('.llm-flag-btn');
            if (flagBtn && !flagBtn.disabled) {
                e.preventDefault();
                flagBtn.click();
            }
            return;
        }
    });

    // Add Language Modal
    const addLanguageModal = document.getElementById('add-language-modal');
    const languageSelect = document.getElementById('language-select');
    const customLanguageInput = document.getElementById('custom-language-input');
    const customLanguageCode = document.getElementById('custom-language-code');
    const addLanguageError = document.getElementById('add-language-error');
    const confirmAddLanguageBtn = document.getElementById('confirm-add-language');

    document.getElementById('add-language-btn').addEventListener('click', () => {
        // Reset modal state
        languageSelect.value = '';
        customLanguageCode.value = '';
        customLanguageInput.classList.add('hidden');
        addLanguageError.classList.add('hidden');
        confirmAddLanguageBtn.disabled = true;
        addLanguageModal.classList.remove('hidden');
    });

    document.getElementById('cancel-add-language').addEventListener('click', () => {
        addLanguageModal.classList.add('hidden');
    });

    languageSelect.addEventListener('change', () => {
        const value = languageSelect.value;
        if (value === 'custom') {
            customLanguageInput.classList.remove('hidden');
            confirmAddLanguageBtn.disabled = !customLanguageCode.value.trim();
        } else {
            customLanguageInput.classList.add('hidden');
            confirmAddLanguageBtn.disabled = !value;
        }
        addLanguageError.classList.add('hidden');
    });

    customLanguageCode.addEventListener('input', () => {
        confirmAddLanguageBtn.disabled = !customLanguageCode.value.trim();
        addLanguageError.classList.add('hidden');
    });

    confirmAddLanguageBtn.addEventListener('click', async () => {
        const selectedValue = languageSelect.value;
        const langCode = selectedValue === 'custom'
            ? customLanguageCode.value.trim()
            : selectedValue;

        if (!langCode) return;

        confirmAddLanguageBtn.disabled = true;
        confirmAddLanguageBtn.innerHTML = `
            <svg class="animate-spin h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        `;

        try {
            const response = await fetch(`/api/languages/${fileId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ language: langCode }),
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to add language');
            }

            const result = await response.json();

            // Success - close modal and refresh sidebar
            addLanguageModal.classList.add('hidden');
            const appliedMsg = result.applied_to_disk ? ' (saved to file)' : '';
            showToast(`Added language: ${langCode}${appliedMsg}`, 'success');
            loadLanguageSidebar();

            // Navigate to the new language
            window.location.href = `/review/${langCode}`;

        } catch (error) {
            addLanguageError.textContent = error.message;
            addLanguageError.classList.remove('hidden');
            confirmAddLanguageBtn.disabled = false;
            confirmAddLanguageBtn.textContent = 'Add Language';
        }
    });

    // ==========================================
    // Tab Management
    // ==========================================

    function switchTab(tabId) {
        activeTab = tabId;

        // Update tab button styles
        document.querySelectorAll('.tab-btn').forEach(btn => {
            const isActive = btn.dataset.tab === tabId;
            btn.setAttribute('aria-selected', isActive);

            if (isActive) {
                btn.classList.remove('text-gray-400', 'border-transparent', 'hover:text-gray-300');
                if (tabId === 'untranslated') {
                    btn.classList.add('text-emerald-400', 'border-emerald-500', 'bg-emerald-900/10');
                } else if (tabId === 'needs_review') {
                    btn.classList.add('text-yellow-400', 'border-yellow-500', 'bg-yellow-900/10');
                } else {
                    btn.classList.add('text-blue-400', 'border-blue-500', 'bg-blue-900/10');
                }
            } else {
                btn.classList.remove('text-emerald-400', 'border-emerald-500', 'bg-emerald-900/10',
                                     'text-yellow-400', 'border-yellow-500', 'bg-yellow-900/10',
                                     'text-blue-400', 'border-blue-500', 'bg-blue-900/10');
                btn.classList.add('text-gray-400', 'border-transparent', 'hover:text-gray-300');
            }
        });

        // Update contextual actions visibility
        updateTabActions(tabId);

        // Load translations with appropriate filter
        let filter = '';
        if (tabId === 'untranslated') {
            filter = 'not_translated';
        } else if (tabId === 'needs_review') {
            filter = 'needs_review';
        }
        // 'all' tab uses empty filter

        loadTranslations(filter);

        // Update URL for bookmarking
        const url = new URL(window.location);
        url.searchParams.set('tab', tabId);
        history.replaceState({}, '', url);
    }

    function updateTabActions(tabId) {
        const translateAllBtn = document.getElementById('translate-all-btn');
        const verifyBtn = document.getElementById('verify-btn');
        const viewResultsBtn = document.getElementById('view-last-results-btn');
        const searchContainer = document.getElementById('search-container');
        const stateFilterSelect = document.getElementById('state-filter-select');

        // Hide all first
        translateAllBtn.classList.add('hidden');
        verifyBtn.classList.add('hidden');
        searchContainer.classList.add('hidden');
        stateFilterSelect.classList.add('hidden');

        if (tabId === 'untranslated') {
            translateAllBtn.classList.remove('hidden');
        } else if (tabId === 'needs_review') {
            verifyBtn.classList.remove('hidden');
            // Show View Results if we have last results
            if (llmReviewState.accumulatedIssues.length > 0) {
                viewResultsBtn.classList.remove('hidden');
            }
        } else if (tabId === 'all') {
            searchContainer.classList.remove('hidden');
            stateFilterSelect.classList.remove('hidden');
        }
    }

    function updateTabBadges() {
        // Update badge counts
        document.getElementById('badge-untranslated').textContent = tabCounts.untranslated;
        document.getElementById('badge-all').textContent = `(${tabCounts.total})`;

        const needsReviewBadge = document.getElementById('badge-needs-review');
        const needsReviewCount = tabCounts.needs_review + tabCounts.flagged;
        needsReviewBadge.textContent = needsReviewCount;
        if (needsReviewCount > 0) {
            needsReviewBadge.classList.remove('hidden');
        } else {
            needsReviewBadge.classList.add('hidden');
        }

        // Update step indicator counts
        const translateCount = document.getElementById('step-translate-count');
        if (tabCounts.untranslated > 0) {
            translateCount.textContent = `(${tabCounts.untranslated})`;
            translateCount.classList.remove('hidden');
        } else {
            translateCount.classList.add('hidden');
        }

        const reviewCount = document.getElementById('step-review-count');
        if (needsReviewCount > 0) {
            reviewCount.textContent = `(${needsReviewCount})`;
            reviewCount.classList.remove('hidden');
        } else {
            reviewCount.classList.add('hidden');
        }

        // Update step indicator styles based on progress
        updateStepIndicator();
    }

    function updateStepIndicator() {
        const stepTranslate = document.getElementById('step-translate');
        const stepVerify = document.getElementById('step-verify');
        const stepReview = document.getElementById('step-review');
        const stepExport = document.getElementById('step-export');
        const connectorTranslate = document.getElementById('connector-translate');
        const connectorVerify = document.getElementById('connector-verify');
        const connectorReview = document.getElementById('connector-review');

        // Translate step: complete if no untranslated, active if some untranslated
        if (tabCounts.untranslated === 0 && tabCounts.total > 0) {
            setStepComplete(stepTranslate);
            connectorTranslate.classList.remove('bg-gray-600');
            connectorTranslate.classList.add('bg-emerald-600');
        } else if (tabCounts.untranslated > 0) {
            setStepActive(stepTranslate);
        }

        // Verify step: active after translate complete
        if (tabCounts.untranslated === 0 && tabCounts.total > 0) {
            const needsReviewCount = tabCounts.needs_review + tabCounts.flagged;
            if (needsReviewCount === 0) {
                setStepComplete(stepVerify);
                connectorVerify.classList.remove('bg-gray-600');
                connectorVerify.classList.add('bg-emerald-600');
            } else {
                setStepActive(stepVerify);
            }
        }

        // Review step: active if there are items needing review
        const needsReviewCount = tabCounts.needs_review + tabCounts.flagged;
        if (needsReviewCount > 0) {
            setStepActive(stepReview);
        } else if (tabCounts.untranslated === 0 && tabCounts.total > 0) {
            setStepComplete(stepReview);
            connectorReview.classList.remove('bg-gray-600');
            connectorReview.classList.add('bg-emerald-600');
        }

        // Export step: ready when all translations are done
        if (tabCounts.untranslated === 0 && needsReviewCount === 0 && tabCounts.total > 0) {
            setStepReady(stepExport);
        }
    }

    function setStepComplete(stepEl) {
        stepEl.classList.remove('bg-gray-700/50', 'border-gray-600');
        stepEl.classList.add('bg-emerald-600/20', 'border-emerald-600/50');
        const circle = stepEl.querySelector('div');
        circle.classList.remove('bg-gray-600');
        circle.classList.add('bg-emerald-600');
        circle.innerHTML = '<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>';
        const label = stepEl.querySelector('span');
        label.classList.remove('text-gray-400');
        label.classList.add('text-emerald-400');
    }

    function setStepActive(stepEl) {
        stepEl.classList.remove('bg-gray-700/50', 'border-gray-600');
        stepEl.classList.add('bg-blue-600/20', 'border-blue-600/50');
        const circle = stepEl.querySelector('div');
        circle.classList.remove('bg-gray-600');
        circle.classList.add('bg-blue-600');
        const label = stepEl.querySelector('span');
        label.classList.remove('text-gray-400');
        label.classList.add('text-blue-400');
    }

    function setStepReady(stepEl) {
        stepEl.classList.remove('bg-gray-700/50', 'border-gray-600');
        stepEl.classList.add('bg-emerald-600/20', 'border-emerald-600/50');
        const circle = stepEl.querySelector('div');
        circle.classList.remove('bg-gray-600');
        circle.classList.add('bg-emerald-600');
        const label = stepEl.querySelector('span');
        label.classList.remove('text-gray-400');
        label.classList.add('text-emerald-400');
    }

    // Setup tab click handlers
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            switchTab(btn.dataset.tab);
        });
    });

    // More menu dropdown toggle
    document.getElementById('more-menu-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        const dropdown = document.getElementById('more-menu-dropdown');
        dropdown.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
        document.getElementById('more-menu-dropdown').classList.add('hidden');
    });

    // State filter select handler (All tab)
    document.getElementById('state-filter-select').addEventListener('change', (e) => {
        loadTranslations(e.target.value);
    });

    // ==========================================
    // Initialize
    // ==========================================

    // Parse URL params for initial tab
    const urlParams = new URLSearchParams(window.location.search);
    const initialTab = urlParams.get('tab') || 'untranslated';
    const initialFilter = urlParams.get('filter') || '';

    // If there's a filter param, switch to All tab
    if (initialFilter && !urlParams.has('tab')) {
        switchTab('all');
        document.getElementById('state-filter-select').value = initialFilter;
        loadTranslations(initialFilter);
    } else {
        switchTab(initialTab);
    }

    loadLanguageSidebar();
</script>
{% endif %}
{% endblock %}
